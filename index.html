<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìœ¡ì¹ íšŒ íšŒë¹„ ì¥ë¶€</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b0f14; --card:#101824; --line:#1a2533; --txt:#e7eef7; --muted:rgba(231,238,247,.75);
      --btn:#1c63ff; --btn2:#122a55; --warn:#ffb020; --ok:#6bff9a; --bad:#ff6b6b;
      --practiceLine: rgba(107,255,154,.65); --practiceBg: rgba(107,255,154,.06);
}
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--txt); }
    header{ position:sticky; top:0; background:var(--bg); border-bottom:1px solid var(--line); padding:14px 16px; display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; justify-content:space-between; }
    h1{ margin:2px 0; font-size:18px; }
    main{ max-width:1100px; margin:0 auto; padding:16px; display:grid; gap:12px; }
    /* ğŸ”° ì—°ìŠµ ëª¨ë“œ: ì•± ë°”ê¹¥(ìµœìƒìœ„ ì¹´ë“œ) í…Œë‘ë¦¬ë¥¼ ë…¹ìƒ‰ìœ¼ë¡œ */
    body.practice #appCard{ border-color: var(--practiceLine); }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; }
.row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    @media (max-width: 860px){ .grid2,.grid3{ grid-template-columns:1fr; } }

    input, select, textarea{ width:100%; background:var(--bg); border:1px solid var(--line); color:var(--txt); border-radius:12px; padding:10px 12px; }
    textarea{ min-height:80px; resize:vertical; }
    button{ background:var(--btn); border:none; color:white; padding:10px 12px; border-radius:12px; cursor:pointer; }
    button.secondary{ background:transparent; border:1px solid #2a3a52; color:var(--txt); }
    button.ghost{ background:transparent; border:1px solid var(--line); color:var(--txt); }
    button.danger{ background:rgba(255,107,107,.14); border:1px solid rgba(255,107,107,.55); color:var(--txt); }
    button.danger:hover{ border-color:rgba(255,107,107,.9); }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .muted{ color:var(--muted); }
    .tiny{ font-size:12px; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:3px 10px; border:1px solid var(--line); border-radius:999px; font-size:12px; background:rgba(255,255,255,.03); }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{ padding:8px 10px; border-radius:999px; border:1px solid var(--line); background:transparent; color:var(--txt); cursor:pointer; }
    .tab.active{ background:rgba(28,99,255,.2); border-color:rgba(28,99,255,.55); }

    .hidden{ display:none !important; }
    .split{ display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center; }
    .hr{ height:1px; background:var(--line); margin:10px 0; }

    .tx{ padding:10px 0; border-bottom:1px solid var(--line); }
    /* ì§€ì¶œ(OUT) ì¤„ë§Œ ì˜…ì€ ë¹¨ê°• í‹´íŠ¸ */
    .tx.outTint{ background:rgba(255,107,107,.07); padding:10px 10px; border-radius:12px; margin:4px 0; }
    .memo{ white-space: pre-line; }
    .memoClamp{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .txTop{ display:flex; gap:10px; justify-content:space-between; align-items:flex-start; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--line); background:rgba(255,255,255,.03); font-size:12px; }
    .linkBtn{ background:transparent; border:1px solid #2a3a52; padding:6px 10px; border-radius:10px; color:var(--txt); cursor:pointer; }

    /* ì²´í¬ë°•ìŠ¤ ê¸°ë³¸ width(100%) ì˜ˆì™¸ ì²˜ë¦¬ */
    input[type="checkbox"]{ width:auto; padding:0; margin:0; border:none; background:transparent; border-radius:0; appearance:auto; }

    /* í† ê¸€ ìŠ¤ìœ„ì¹˜(ì—°ìŠµ ëª¨ë“œ) */
    .switch{ position:relative; display:inline-flex; width:54px; height:32px; }
    .switch input{ opacity:0; width:0; height:0; }
    .switch .slider{ position:absolute; inset:0; cursor:pointer; background:rgba(255,255,255,.06); border:1px solid var(--line); border-radius:999px; transition:.18s ease; }
    .switch .slider:before{ content:""; position:absolute; width:24px; height:24px; left:3px; top:3px; border-radius:999px; background:rgba(231,238,247,.92); transition:.18s ease; }
    .switch input:checked + .slider{ background:rgba(107,255,154,.18); border-color:rgba(107,255,154,.62); }
    .switch input:checked + .slider:before{ transform:translateX(22px); background:var(--ok); }

    /* ì—°ë„ë³„ ì›” ì†Œê³„(í•©ê³„) ì¤„ */
    .txSum{ background:rgba(28,99,255,.10); border:1px dashed rgba(28,99,255,.35); padding:10px 10px; border-radius:12px; margin:8px 0; }
    .txSum .sumLine{ display:flex; flex-wrap:wrap; gap:10px; justify-content:space-between; align-items:center; }
    .txSum .sumLeft{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    .txSum .sumRight{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .txSum .sumNum{ font-weight:800; }

    .statusGrid{ display:grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap:8px; }
    @media (max-width: 860px){ .statusGrid{ grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    .monthBox{ border:1px solid var(--line); border-radius:12px; padding:10px; background:rgba(255,255,255,.02); }
    .k{ font-size:12px; opacity:.85; }
    .v{ font-size:13px; margin-top:4px; }
    .ok{ color:var(--ok); }
    .bad{ color:var(--bad); }
    .warn{ color:var(--warn); }

    .toast{ position:fixed; left:12px; right:12px; bottom:12px; max-width:1100px; margin:0 auto; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:rgba(16,24,36,.96); display:none; }
    .toast.show{ display:block; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .bigMoney{ font-size:36px; font-weight:800; letter-spacing:-0.5px; }
    @media (max-width: 860px){ .bigMoney{ font-size:30px; } }

    .balanceCenter{ text-align:center; }
    .balanceHighlight{ display:inline-block; padding:10px 14px; border:1px solid rgba(107,255,154,.35); background:rgba(107,255,154,.08); border-radius:16px; margin-top:6px; }
    .balanceMeta{ justify-content:center; }

    /* ë„ì›€ë§ ëª¨ë‹¬ */
    .helpBtn{ background:transparent; border:1px solid #2a3a52; color:var(--txt); padding:6px 10px; border-radius:999px; cursor:pointer; font-size:12px; }
    .helpBtn:hover{ border-color:rgba(28,99,255,.65); }

    .modalOverlay{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:flex-end; justify-content:center; padding:14px; z-index:9999; }
    @media (min-width: 860px){ .modalOverlay{ align-items:center; } }
    .modalCard{ width:min(860px, 100%); max-height:min(82vh, 820px); overflow:auto; background:var(--card); border:1px solid var(--line); border-radius:16px; padding:14px; }
    .modalTitle{ margin:0; font-size:18px; }
    .modalClose{ background:transparent; border:1px solid var(--line); color:var(--txt); padding:8px 10px; border-radius:12px; cursor:pointer; }
    .helpH{ margin:14px 0 6px; font-size:14px; }
    .helpList{ margin:8px 0 0; padding-left:18px; }
    .helpWarn{ border:1px solid rgba(255,176,32,.35); background:rgba(255,176,32,.08); padding:10px 12px; border-radius:12px; }

    /* ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸(ê°¹ì¶œ) */
    .eventBox{ border:1px solid var(--line); border-radius:12px; padding:12px; background:rgba(255,255,255,.02); margin:8px 0; }
    .progress{ height:8px; background:rgba(255,255,255,.06); border-radius:999px; overflow:hidden; }
    .progress > div{ height:100%; background:rgba(255,176,32,.85); width:0%; }

    /* ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸: ì œì™¸ íšŒì› ì„ íƒ UI */
    .checkList{ max-height:160px; overflow:auto; border:1px solid var(--line); border-radius:12px; padding:10px; background:rgba(0,0,0,.12); }
    .checkItem{ display:flex; align-items:center; gap:8px; padding:6px 4px; border-bottom:1px dashed rgba(255,255,255,.08); }
    .checkItem:last-child{ border-bottom:none; }
    .checkItem input{ width:auto; }

    .file{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border:1px dashed #2a3a52; border-radius:12px; cursor:pointer; }
    .file input{ display:none; }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>ìœ¡ì¹ íšŒ íšŒë¹„ ì¥ë¶€</h1>
      <div class="muted tiny">íšŒì› ë¡œê·¸ì¸ í›„ ì—´ëŒ ê°€ëŠ¥. ì´ë¬´ë§Œ ìˆ˜ì •/ë“±ë¡ ê°€ëŠ¥.</div>
    </div>

    <div style="min-width:340px; max-width:520px; width:520px;">
      <div class="row" style="justify-content:flex-end;">
        <span id="roleBadge" class="badge hidden"></span>
      </div>
      <div class="row" id="loginRow">
        <input id="email" type="email" placeholder="ì´ë©”ì¼" autocomplete="username" />
        <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
        <button id="btnLogin">ë¡œê·¸ì¸</button>
      </div>
      <div class="row hidden" id="logoutRow" style="justify-content:space-between;">
        <div>
          <div id="userLabel" class="muted"></div>
          <div id="uidLabel" class="muted tiny mono"></div>
        </div>
        <button id="btnLogout" class="secondary">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card" id="lockedCard">
      <h2>ì ê¸ˆ</h2>
      <p class="muted">íšŒì› ê³µìš© ê³„ì • ë˜ëŠ” ì´ë¬´ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.</p>
      <ul class="muted">
        <li>ì…ê¸ˆ ë‚´ì—­ì€ <b>ì…ê¸ˆì ê³µê°œ</b>ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</li>      <li>ì˜ìˆ˜ì¦ ì‚¬ì§„ì€ ì•±ì—ì„œ ë‹¤ë£¨ì§€ ì•Šê³ , ë„¤ì´ë²„ ë°´ë“œì— ì—…ë¡œë“œí•©ë‹ˆë‹¤.</li>
      </ul>
    </section>

    <section class="card hidden" id="appCard">
      <div class="split">
        <div class="tabs" id="tabs">
          <button class="tab active" data-tab="dashboard">ëŒ€ì‹œë³´ë“œ</button>
          <button class="tab" data-tab="members">íšŒì›</button>
          <button class="tab" data-tab="settings">ì„¤ì •</button>
          <button class="tab" data-tab="admin">ì´ë¬´ì…ë ¥</button>
        </div>
        <div class="row">
          <span class="muted tiny">ì½ê¸°ì „ìš©: íšŒì›</span>
          <span class="muted tiny">ì“°ê¸°: ì´ë¬´</span>
        </div>
      </div>

      <div class="hr"></div>

      <!-- Dashboard -->
      <div id="tab-dashboard">
        <div class="card" style="margin:0;">
          <div class="split">
            <h2 style="margin:0;">ì”ê³ </h2>
            <span id="yearPill" class="pill">ì˜¬í•´</span>
          </div>

          <div class="balanceCenter" style="margin-top:12px;">
            <div id="balanceHint" class="muted tiny">í˜„ì¬ ì”ê³ (ê¸°ì´ˆ ì”ê³  + ì˜¬í•´ ì…ê¸ˆ - ì˜¬í•´ ì§€ì¶œ)</div>
            <div class="balanceHighlight"><div id="balanceBig" class="bigMoney mono">0ì›</div></div>

            <div class="row balanceMeta" style="margin-top:12px; gap:18px;">
              <div>
                <div id="openingTitle" class="muted tiny">ê¸°ì´ˆ ì”ê³ </div>
                <div id="openingLabel" class="mono">0ì›</div>
              </div>
              <div>
                <div id="inSumTitle" class="muted tiny">ì…ê¸ˆ í•©ê³„</div>
                <div id="inSumLabel" class="mono">0ì›</div>
              </div>
              <div>
                <div id="outSumTitle" class="muted tiny">ì§€ì¶œ í•©ê³„</div>
                <div id="outSumLabel" class="mono">0ì›</div>
              </div>
            </div>

            <div class="muted tiny" style="margin-top:10px;">â€» ì…ê¸ˆ/ì§€ì¶œ í•©ê³„ëŠ” <b>ì˜¬í•´(1/1~12/31)</b>ë§Œ ì§‘ê³„í•©ë‹ˆë‹¤. í•´ê°€ ë°”ë€Œë©´ 0ë¶€í„° ë‹¤ì‹œ ì§‘ê³„ë©ë‹ˆë‹¤.</div>
          </div>
        </div>

        <div class="grid2">
          <div class="card" style="margin:0;">
            <div class="split">
              <div class="row" style="gap:10px;">
                <h2 style="margin:0;">ê±°ë˜ ë‚´ì—­</h2>
                <span id="txCount" class="muted tiny"></span>
              </div>
              <div class="row">
                <select id="txViewMode" style="width:140px;">
                  <option value="RECENT">ìµœê·¼ 120ê±´</option>
                  <option value="YEAR">ì—°ë„ë³„</option>
                </select>
                <select id="txYearSelect" style="width:120px;" class="hidden"></select>
                <select id="txTypeFilter" style="width:120px;" class="hidden">
                  <option value="ALL">ì „ì²´</option>
                  <option value="IN">ì…ê¸ˆë§Œ</option>
                  <option value="OUT">ì§€ì¶œë§Œ</option>
                </select>
                <label id="txMonthSumWrap" class="badge hidden" style="cursor:pointer; user-select:none;">
                  <input id="txMonthSum" type="checkbox" checked />
                  <span>ì›”ë³„ í•©ê³„</span>
                </label>
                <span id="txViewBadge" class="pill hidden"></span>
                <input id="txFilter" placeholder="ê²€ìƒ‰(ì´ë¦„/ë©”ëª¨/ê¸ˆì•¡)" style="width:220px;" />
                <button id="btnRefresh" class="secondary">ìƒˆë¡œê³ ì¹¨</button>
              </div>
            </div>
            <div id="txList" style="margin-top:8px;"></div>
          </div>

          <div class="card" style="margin:0;">
            <h2 style="margin:0;">íšŒì› ë‚©ë¶€ í˜„í™©</h2>

            <div class="row" style="margin-top:8px;">
              <input id="rangeStart" placeholder="ë¶€í„°ë‚ ì§œ (YYYY-MM)" style="width:160px;" />
              <input id="rangeEnd" placeholder="ê¹Œì§€ë‚ ì§œ (YYYY-MM)" style="width:160px;" />
              <button id="btnQuickRange" class="secondary">ìµœê·¼ 12ê°œì›”</button>
            </div>

            <div class="row" style="margin-top:8px;">
              <select id="memberSelect" style="width:220px;"></select>
              <button id="btnLoadStatus" class="secondary">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>

            <div class="row" style="margin-top:8px; justify-content:space-between;">
              <div>
                <div class="muted tiny">ì„ ìˆ˜ê¸ˆ</div>
                <div id="creditLabel" class="mono">0ì›</div>
              </div>
              <div>
                <div class="muted tiny">ë¯¸ë‚© í•©ê³„</div>
                <div id="arrearsLabel" class="mono bad">0ì›</div>
              </div>
            </div>

            <div id="statusGrid" class="statusGrid" style="margin-top:10px;"></div>
            <div class="muted tiny" style="margin-top:8px;">ìƒíƒœ: <span class="ok">ì™„ë‚©</span> / <span class="warn">ë¶€ë¶„ë‚©Â·ë¯¸ë‚©</span> / <span class="muted">ë©´ì œ</span></div>
          </div>
        </div>

        <div class="card" style="margin:0;">
          <div class="split">
            <h2 style="margin:0;">ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ / ê°¹ì¶œ</h2>
            <div class="row">
              <button id="btnReloadEvents" class="secondary">ìƒˆë¡œê³ ì¹¨</button>
            </div>
          </div>
          <div id="eventList" style="margin-top:8px;"></div>
          <div class="muted tiny" style="margin-top:8px;">â€» ì´ë¬´ê°€ ë§Œë“  ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ë³„ë¡œ, ë‹¹ì‚¬ì(ë³¸ì¸)ë¥¼ ìë™ ì œì™¸í•œ ê°¹ì¶œ ë‚©ë¶€ í˜„í™©ì„ ê³µìœ í•©ë‹ˆë‹¤.</div>
        </div>
      </div>

      <!-- Members -->
      <div id="tab-members" class="hidden">
        <div class="grid2">
          <div class="card" style="margin:0;">
            <div class="split">
              <h2 style="margin:0;">íšŒì› ëª©ë¡</h2>
              <button id="btnReloadMembers" class="secondary">ìƒˆë¡œê³ ì¹¨</button>
            </div>
            <div id="memberList" style="margin-top:8px;"></div>
          </div>

          <div class="card" style="margin:0;">
            <h2 style="margin:0;">íšŒì› ê´€ë¦¬</h2>
            <p class="muted tiny">íšŒì› IDëŠ” <b>ì´ë¦„ ê·¸ëŒ€ë¡œ</b> ì‚¬ìš©í•©ë‹ˆë‹¤. ë™ëª…ì´ì¸/ì˜¤íƒ€ ë°©ì§€ë¥¼ ìœ„í•´ ì…ë ¥ì€ ì‹ ì¤‘í•˜ê²Œ.</p>

            <div class="grid2">
              <input id="mName" placeholder="íšŒì› ì´ë¦„(ì˜ˆ: ê¹€ë§¹êµ¬)" />
              <input id="mActiveFrom" placeholder="í™œë™ ì‹œì‘ì›”(YYYY-MM)" />
              <input id="mActiveTo" placeholder="í™œë™ ì¢…ë£Œì›”(ì—†ìœ¼ë©´ ë¹„ì›€)" />
              <button id="btnUpsertMember">íšŒì› ì €ì¥</button>
            </div>

            <div class="hr"></div>

            <h3 style="margin:0 0 8px;">íšŒë¹„ ë©´ì œ ê¸°ê°„ ì¶”ê°€</h3>
            <div class="grid3">
              <select id="exMember" ></select>
              <input id="exFrom" placeholder="ë©´ì œ ì‹œì‘ì›”(YYYY-MM)" />
              <input id="exTo" placeholder="ë©´ì œ ì¢…ë£Œì›”(YYYY-MM)" />
              <input id="exReason" placeholder="ì‚¬ìœ (ì˜ˆ: ê°œì¸ì‚¬ì •)" />
              <button id="btnAddExemption">ë©´ì œ ì¶”ê°€</button>
            </div>
            <p class="muted tiny">ë©´ì œëŠ” í•´ë‹¹ ê¸°ê°„ì˜ ì›”íšŒë¹„ ì²­êµ¬ë¥¼ 0ì›ìœ¼ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div id="tab-settings" class="hidden">

        <!-- ğŸ”° ì—°ìŠµ ëª¨ë“œ(ì´ë¬´ ì „ìš©) -->
        <div id="practiceToggleWrap" class="card hidden" style="margin:0; border:1px solid var(--practiceLine); background:var(--practiceBg);">
          <div class="split" style="align-items:flex-start;">
            <div style="min-width:260px;">
              <h2 style="margin:0;">ğŸ”° ì—°ìŠµ ëª¨ë“œ (ì´ë¬´ ì „ìš©)</h2>
              <div class="muted tiny" style="margin-top:8px; line-height:1.55;">
                ì´ ìŠ¤ìœ„ì¹˜ë¥¼ ì¼œë©´ <b>ê°€ì§œ ë°ì´í„°(Demo)</b> ê³µê°„ìœ¼ë¡œ ì ‘ì†í•©ë‹ˆë‹¤.<br/>
                ì‹¤ì œ ë°ì´í„°ë¥¼ ê±´ë“œë¦¬ì§€ ì•Šê³ , ë§ˆìŒê» ì…ë ¥/ì‚­ì œ í…ŒìŠ¤íŠ¸ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>
                <span class="muted">(ì¸ìˆ˜ì¸ê³„ ì‹œ ì—°ìŠµìš©ìœ¼ë¡œ ì‚¬ìš©í•˜ì„¸ìš”. ë„ë©´ ì‹¤ì œ ì¥ë¶€ë¡œ ëŒì•„ì˜µë‹ˆë‹¤.)</span>
              </div>
              <div class="muted tiny" style="margin-top:10px;">
                í˜„ì¬ ìƒíƒœ: <b id="practiceStatus" class="mono"></b>
              </div>
            </div>

            <div class="row" style="justify-content:flex-end; gap:10px;">
              <label class="switch" title="ì—°ìŠµ ëª¨ë“œ ì¼œê¸°/ë„ê¸°">
                <input id="practiceToggle" type="checkbox" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="muted tiny" style="margin-top:10px;">
            â€» ì—°ìŠµ ëª¨ë“œì—ì„œëŠ” <b>ë°ëª¨ ì»¬ë ‰ì…˜</b>ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤. (ê³„ì •/ê¶Œí•œì€ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
          </div>
        </div>

        <div class="grid2">
          <div class="card" style="margin:0;">
            <h2 style="margin:0;">íšŒë¹„ ì„¤ì •(íŠ¹ì • ì›”ë¶€í„° ì ìš©)</h2>
            <p class="muted tiny">ì˜ˆ: 2026-02ë¶€í„° 25,000ì›</p>

            <div class="grid2">
              <input id="feeFrom" placeholder="ì ìš© ì‹œì‘ì›”(YYYY-MM)" />
              <input id="feeAmount" type="number" placeholder="ê¸ˆì•¡" />
              <button id="btnAddFee" class="secondary">ì„¤ì • ì¶”ê°€</button>
              <button id="btnSaveConfig">ì €ì¥</button>
            </div>

            <div id="feeHistory" style="margin-top:10px;"></div>
            <p class="muted tiny">â€» <b class="bad">ì €ì¥ ë²„íŠ¼ì„ ê¼­ ëˆŒëŸ¬ì•¼</b>, ì›” ìƒì„±/ì¬ìƒì„± ì‹œ í•´ë‹¹ ê¸ˆì•¡ì´ ë°˜ì˜ë©ë‹ˆë‹¤.</p>
          </div>

          <div class="card" style="margin:0;">

<div class="split">
  <h2 style="margin:0;">ì›” ìƒì„±</h2>
  <button id="btnMonthGenHelp" class="helpBtn" title="ì›” ìƒì„± ë„ì›€ë§">ë„ì›€ë§ â”</button>
</div>

            <p class="muted tiny">FIFO ìë™ë°°ì •ì„ ìœ„í•´ íšŒì›ë³„ ì›” ì²­êµ¬( memberPeriods )ë¥¼ ë¯¸ë¦¬ ë§Œë“¤ì–´ ë‘¡ë‹ˆë‹¤.</p>

            <div class="grid2">
              <input id="genStart" placeholder="ìƒì„± ì‹œì‘ì›”(YYYY-MM)" />
              <input id="genEnd" placeholder="ìƒì„± ì¢…ë£Œì›”(YYYY-MM)" />
              <button id="btnGenForAll">ì „ì²´ íšŒì› ìƒì„±</button>
              <button id="btnGenForOne" class="secondary">ì„ íƒ íšŒì› ìƒì„±</button>
            </div>

            <div class="row" style="margin-top:10px;">
              <select id="genMember" style="width:220px;"></select>
              <button id="btnRecalcRange" class="ghost">(ì£¼ì˜) ë²”ìœ„ ì¬ê³„ì‚°</button>
            </div>
            <p class="muted tiny">"ì¬ê³„ì‚°"ì€ ë©´ì œ/íšŒë¹„ ë³€ê²½ì„ ë°˜ì˜í•´ dueë¥¼ ë‹¤ì‹œ ê³„ì‚°í•©ë‹ˆë‹¤. paidëŠ” ìœ ì§€ë©ë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>

      <!-- Admin -->
      <div id="tab-admin" class="hidden">

        <div class="card" style="margin:0;" id="adminEventCard">
          <div class="split">
            <h2 style="margin:0;">ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ / ê°¹ì¶œ ìƒì„±</h2>
            <span class="muted tiny">â€˜ê²½ì¡°ì‚¬ íšŒì› ë³¸ì¸â€™ì„ ì„ íƒí•˜ë©´ <b>ë³¸ì¸ì€ ìë™ ì œì™¸</b>ë©ë‹ˆë‹¤. ì¶”ê°€ë¡œ â€˜ì œì™¸ íšŒì› ì„ íƒâ€™ì—ì„œ ì§€ì •í•œ íšŒì›ë„ ì´ë²ˆ ì´ë²¤íŠ¸ì˜ ê°¹ì¶œ ëŒ€ìƒì—ì„œ ì œì™¸ë©ë‹ˆë‹¤.</span>
          </div>

          <div class="grid3" style="margin-top:10px;">
            <input id="evTitle" placeholder="ì´ë²¤íŠ¸ëª…(ì˜ˆ: ë¶€ì¹œìƒ/ì¥ì¸ìƒ/ìë…€ê²°í˜¼)" />
            <select id="evTargetMember"></select>
            <input id="evPerAmount" type="number" placeholder="1ì¸ë‹¹ ê°¹ì¶œ ê¸ˆì•¡(ì˜ˆ: 100000)" />
            <input id="evDate" type="date" />
            <input id="evMemo" placeholder="ë©”ëª¨(ì„ íƒ)" />
          </div>

          <div style="margin-top:10px;">
            <div class="muted tiny">ì œì™¸ íšŒì› ì„ íƒ(ì„ íƒ)</div>
            <div id="evExcludeList" class="checkList"></div>
            <div class="muted tiny" style="margin-top:6px;">â€» ì—¬ê¸°ì„œ ì œì™¸í•œ íšŒì›ì€ ì´ë²ˆ ì´ë²¤íŠ¸ì˜ ê°¹ì¶œ ëŒ€ìƒì—ì„œ ë¹ ì§‘ë‹ˆë‹¤. (ê²½ì¡°ì‚¬ íšŒì› ë³¸ì¸ì€ ìë™ ì œì™¸)</div>
          </div>

          <div class="row" style="margin-top:10px; justify-content:flex-end;">
            <button id="btnCreateEvent">ì´ë²¤íŠ¸ ìƒì„±(ì„ ì§€ì¶œ+ê°¹ì¶œ ìƒì„±)</button>
          </div>

          <p class="muted tiny">ìƒì„± ì‹œ: (1) íšŒë¹„í†µì¥ì—ì„œ ë‹¹ì‚¬ìì—ê²Œ ì§€ê¸‰í•œ ê¸ˆì•¡ì„ <b>ì§€ì¶œ(OUT)</b>ë¡œ ê¸°ë¡í•˜ê³ , (2) íšŒì›ë³„ ê°¹ì¶œ ë‚©ë¶€ ëŒ€ìƒ(ë¯¸ë‚©)ì„ ìƒì„±í•©ë‹ˆë‹¤.</p>
        </div>

        <div class="card" style="margin:0;">
          <div class="split">
            <h2 style="margin:0;">ì…ê¸ˆ ë“±ë¡</h2>
            <span class="muted tiny">ì°¸ê³ : â€œì›”íšŒë¹„ ìë™ë°°ì •(FIFO)â€ì„ ì„ íƒí•˜ë©´, ì…ê¸ˆì¼ê³¼ ë¬´ê´€í•˜ê²Œ íšŒì›ì˜ ë°€ë¦° íšŒë¹„ë¶€í„° ë¨¼ì € ìë™ìœ¼ë¡œ ì±„ì›ë‹ˆë‹¤. (ì˜ˆ: 12ì›”ì— ì…ê¸ˆí–ˆì§€ë§Œ 9ì›”ë¶€í„° ë¯¸ë‚©ì´ë©´ 9ì›”ë¶„ë¶€í„° ë‚©ë¶€ë¡œ ì²˜ë¦¬)</span>
          </div>

          <div class="grid3" style="margin-top:10px;">
            <select id="inMember"></select>
            <input id="inAmount" type="number" placeholder="ê¸ˆì•¡" />
            <input id="inDate" type="date" />
            <input id="inMemo" placeholder="ë©”ëª¨(ì„ íƒ)" />

            <select id="inMode">
              <option value="MONTHLY">ì›”íšŒë¹„ ìë™ë°°ì •(FIFO)</option>
              <option value="EVENT">ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ / ê°¹ì¶œ</option>
              <option value="CREDIT">ì„ ìˆ˜ê¸ˆë§Œ ì ë¦½(ë°°ì • ì•ˆ í•¨)</option>
            </select>
            <select id="inEvent" class="hidden"></select>          </div>

          <div class="row" style="margin-top:10px; justify-content:flex-end;">
            <button id="btnAddDeposit">ì…ê¸ˆ ë“±ë¡</button>
          </div>

          <p class="muted tiny">â€» <b>ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ / ê°¹ì¶œ</b> ëª¨ë“œì—ì„œëŠ” ì„ íƒí•œ ì´ë²¤íŠ¸ ê¸°ì¤€ìœ¼ë¡œ ë‚©ë¶€ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤. <b>ë‹¹ì‚¬ì(ë³¸ì¸)ëŠ” ìë™ ì œì™¸</b>ë˜ì–´, ëŒ€ìƒìê°€ ì•„ë‹Œ ê²½ìš° ë‚©ë¶€ ë“±ë¡ì´ ë§‰í™ë‹ˆë‹¤.</p>
        </div>

        <div class="card" style="margin:0;">
          <div class="split">
            <h2 style="margin:0;">ê¸°íƒ€ ìˆ˜ì… ë“±ë¡</h2>
            <span class="muted tiny">ì˜ˆ: ì˜ˆê¸ˆ ì´ì, ê²½ì¡°ì‚¬ ë‹¹ì‚¬ì ì°¬ì¡°ê¸ˆ, íšŒì¥/íšŒì› ì°¬ì¡°ê¸ˆ ë“± (ì›”íšŒë¹„/ê°¹ì¶œê³¼ ë¬´ê´€í•œ ìˆ˜ì…)</span>
          </div>

          <div class="grid3" style="margin-top:10px;">
            <input id="otherInTitle" placeholder="ìˆ˜ì…ë‚´ìš©(ì˜ˆ: ì˜ˆê¸ˆì´ì/ì°¬ì¡°ê¸ˆ)" />
            <input id="otherInAmount" type="number" placeholder="ê¸ˆì•¡" />
            <input id="otherInDate" type="date" />
          </div>

          <div style="margin-top:10px;">
            <textarea id="otherInMemo" placeholder="ë©”ëª¨(ì„ íƒ)&#10;â€» ì¤„ë°”ê¿ˆ ê°€ëŠ¥"></textarea>
          </div>

          <div class="row" style="margin-top:10px; justify-content:flex-end;">
            <button id="btnAddOtherIncome">ê¸°íƒ€ ìˆ˜ì… ë“±ë¡</button>
          </div>
        </div>

        <div class="card" style="margin:0;">
          <div class="split">
            <h2 style="margin:0;">ì§€ì¶œ ë“±ë¡</h2>
            <span class="muted tiny">ì§€ì¶œì€ ê±°ë˜ë‚´ì—­ì— <b>ì§€ì¶œ(OUT)</b>ë¡œ ê¸°ë¡ë˜ê³ , ì”ê³ ì—ì„œ ìë™ ì°¨ê°ë©ë‹ˆë‹¤. ì¦ë¹™ ì‚¬ì§„ì€ ë„¤ì´ë²„ ë°´ë“œì— ì—…ë¡œë“œí•˜ì„¸ìš”.</span>
          </div>

          <div class="grid3" style="margin-top:10px;">
            <select id="outCategory">
              <option value="MEETING">ì •ê¸°ëª¨ì„</option>
              <option value="SUMMER">í•˜ê³„ì•¼ìœ íšŒ</option>
              <option value="CONDOLENCE">ê²½ì¡°ì‚¬</option>
              <option value="YEAR_END">ì†¡ë…„íšŒ</option>
              <option value="ETC">ê¸°íƒ€</option>
            </select>
            <input id="outAmount" type="number" placeholder="ê¸ˆì•¡" />
            <input id="outDate" type="date" />
            <select id="outTargetMember" class="hidden"></select>
          </div>

          <div style="margin-top:10px;">
            <textarea id="outMemo" placeholder="ë©”ëª¨(ìƒì„¸ ì§€ì¶œ ë‚´ì—­)&#10;â€» ì¤„ë°”ê¿ˆ ê°€ëŠ¥ (ì˜ˆ: ì‹ëŒ€ / ì¥ì†ŒëŒ€ê´€ / ìŒë£Œ ë“±)"></textarea>
          </div>

          <div class="muted tiny" id="outTargetHint" style="margin-top:8px; display:none;">
            â€» ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ / ê°¹ì¶œ í™•ì¥ ëŒ€ë¹„: í˜„ì¬ëŠ” ì§€ì¶œ ê¸°ë¡ìš©ìœ¼ë¡œë§Œ ì €ì¥í•˜ë©°, ë‚˜ì¤‘ì— â€œê²½ì¡°ì‚¬ ë‹¹ì‚¬ì(ë³¸ì¸) ì œì™¸ ê°¹ì¶œâ€ì— ì‚¬ìš©ë©ë‹ˆë‹¤.
          </div>

          <div class="row" style="margin-top:10px; justify-content:flex-end;">
            <button id="btnAddExpense">ì§€ì¶œ ë“±ë¡</button>
          </div>
        </div>

        <div class="card" style="margin:0;" id="adminResetCard">
          <div class="split">
            <h2 style="margin:0;">ì”ê³ /ì´ˆê¸°í™”</h2>
            <button id="btnResetMoney" class="ghost" title="ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©: ê¸ˆì•¡ ê´€ë ¨ ë°ì´í„°ë§Œ ì´ˆê¸°í™”">ê¸ˆì•¡ ë°ì´í„° ì´ˆê¸°í™”(ê°œë°œìš©)</button>
            <button id="btnRebuildYearStats" class="secondary" title="ì—°ë„ë³„ ì…ê¸ˆ/ì§€ì¶œ í•©ê³„ë¥¼ ë‹¤ì‹œ ê³„ì‚°">ì—°ë„ í•©ê³„ ì¬ê³„ì‚°</button>
          </div>

          <p class="muted tiny" style="margin-top:8px;">
            ê¸°ì´ˆ ì”ê³ ëŠ” <b>ì˜¬í•´ 1ì›” 1ì¼ ê¸°ì¤€</b>ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤. í•´ê°€ ë°”ë€Œë©´ <b>ì „ë…„ë„(12/31) ê¸°ë§ ì”ê³ </b>ê°€ ìë™ìœ¼ë¡œ <b>ìƒˆí•´ ê¸°ì´ˆ ì”ê³ </b>ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.
          </p>

          <div class="row" style="margin-top:10px;">
            <input id="openingBalance" type="number" placeholder="ì˜¬í•´ ê¸°ì´ˆ ì”ê³ (ì˜ˆ: 1250000)" style="max-width:320px;" />
            <button id="btnSaveOpeningBalance">ì €ì¥</button>
          </div>
          <div class="muted tiny" style="margin-top:6px;">â€» ê¸°ì¡´ ì—‘ì…€ ì¥ë¶€ê°€ ìˆìœ¼ë©´, íŠ¹ì • ê¸°ì¤€ì¼ì˜ í†µì¥ ì”ì•¡ì„ â€˜ê¸°ì´ˆ ì”ê³ â€™ë¡œ ì…ë ¥í•´ ë‘ë©´ í¸í•©ë‹ˆë‹¤.</div>
        </div>
      </div>

    </section>
  </main>
  <!-- ì›” ìƒì„± ë„ì›€ë§ ëª¨ë‹¬ -->
  <div id="helpOverlay" class="modalOverlay hidden" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <div class="modalCard">
      <div class="split" style="align-items:center;">
        <h3 id="helpTitle" class="modalTitle">ì›” ìƒì„± ë„ì›€ë§</h3>
        <button id="btnHelpClose" class="modalClose">ë‹«ê¸°</button>
      </div>
      <div class="hr"></div>
      <div id="helpBody" class="muted"></div>
    </div>
  </div>

  <!-- ê±°ë˜ë‚´ì—­ ë¡±í”„ë ˆìŠ¤(ê¸¸ê²Œëˆ„ë¦„) ì•¡ì…˜ ëª¨ë‹¬ -->
  <div id="txActionOverlay" class="modalOverlay hidden" role="dialog" aria-modal="true" aria-labelledby="txActionTitle">
    <div class="modalCard">
      <div class="split" style="align-items:center;">
        <h3 id="txActionTitle" class="modalTitle">ê±°ë˜ ì •ì •/ì‚­ì œ</h3>
        <button id="btnTxClose" class="modalClose">ë‹«ê¸°</button>
      </div>
      <div class="hr"></div>
      <div id="txActionBody" class="muted"></div>
      <div class="hr"></div>
      <div class="row" style="justify-content:flex-end; gap:8px;">
        <button id="btnTxDelete" class="danger">ì‚­ì œ(ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)</button>
      </div>
      <div class="muted tiny" style="margin-top:10px;">â€» ì›”íšŒë¹„/ê²½ì¡°ì‚¬ ë‚©ë¶€ì²˜ëŸ¼ ë°°ì •ì´ ìˆëŠ” ì…ê¸ˆì€, ê´€ë ¨ ë°°ì •/ì„ ìˆ˜ê¸ˆ/ì´ë²¤íŠ¸ ì§‘ê³„ê¹Œì§€ í•¨ê»˜ ë˜ëŒë¦½ë‹ˆë‹¤.</div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    // ì—ëŸ¬ê°€ ë‚˜ë©´(íŠ¹íˆ GitHub Pagesì—ì„œ) í™”ë©´ì´ ì¡°ìš©íˆ ë©ˆì¶° ë³´ì¼ ìˆ˜ ìˆì–´ì„œ,
    // ì´ˆë³´ìš©ìœ¼ë¡œ ì˜¤ë¥˜ë¥¼ ë°”ë¡œ ë„ìš°ë„ë¡ í•´ë‘¡ë‹ˆë‹¤.
    window.addEventListener('error', (e) => {
      alert('ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜: ' + (e?.message || e));
      console.error(e);
    });
    window.addEventListener('unhandledrejection', (e) => {
      alert('ì²˜ë¦¬ë˜ì§€ ì•Šì€ ì˜¤ë¥˜: ' + (e?.reason?.message || e?.reason || e));
      console.error(e);
    });
    /*********************
     * 0) Firebase ì—°ê²°
     *********************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    import {
      getFirestore,
      doc, getDoc, setDoc, updateDoc,
      collection, addDoc,
      query, where, orderBy, limit, getDocs,
      Timestamp,
      runTransaction,
      writeBatch,
      startAfter,
      increment
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

        // âœ… Firebase ì½˜ì†”ì—ì„œ ë°›ì€ ê°’ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”.
    const firebaseConfig = {
      apiKey: "AIzaSyAvsC0w_oGhA6XSYxTRueTXCgBFsxfyAqk",
      authDomain: "nice67-3d43a.firebaseapp.com",
      projectId: "nice67-3d43a",
      storageBucket: "nice67-3d43a.firebasestorage.app",
      messagingSenderId: "445136711070",
      appId: "1:445136711070:web:33d2a52b7188446dff3a8f"
      // measurementIdëŠ” ì´ ì•±ì—ì„œ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë‹ˆ ë„£ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤.
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
        /*********************
     * 1) DOM helpers
     *********************/
    const $ = (id) => document.getElementById(id);
    const toastEl = $("toast");

    /*********************
     * 1.1) ğŸ”° ì—°ìŠµ ëª¨ë“œ(ì´ë¬´ ì „ìš©)
     * - type="module"ì€ strict modeë¼ì„œ, ì„ ì–¸ ì—†ì´ PRACTICE_MODEì— ëŒ€ì…í•˜ë©´ ë°”ë¡œ ReferenceErrorê°€ ë‚©ë‹ˆë‹¤.
     * - ê¸ˆì•¡/ê±°ë˜ ê´€ë ¨ ì»¬ë ‰ì…˜ì€ demo_ ì ‘ë‘ì‚¬ë¥¼ ë¶™ì—¬ ë³„ë„ ê³µê°„ìœ¼ë¡œ ë¶„ë¦¬í•©ë‹ˆë‹¤.
     *********************/
    let PRACTICE_MODE = false;

    function configDocId(){
      return PRACTICE_MODE ? "demo" : "main";
    }

    function colName(base){
      // ì—°ìŠµëª¨ë“œì—ì„œë§Œ demo_ ì»¬ë ‰ì…˜ìœ¼ë¡œ ë¶„ë¦¬í•  ëŒ€ìƒë“¤
      const demo = new Set(["transactions","allocations","credits","memberPeriods","events","eventMembers","yearStats"]);
      if(!PRACTICE_MODE) return base;
      return demo.has(base) ? `demo_${base}` : base;
    }

    function syncPracticeUI(){
      // âœ… ì—°ìŠµ ëª¨ë“œì¼ ë•Œ ì•±ì˜ ìµœìƒìœ„ ë°•ìŠ¤(#appCard) í…Œë‘ë¦¬ë¥¼ ë…¹ìƒ‰ìœ¼ë¡œ í‘œì‹œ
      document.body.classList.toggle("practice", !!(state?.user && state?.admin && PRACTICE_MODE));

      const wrap = $("practiceToggleWrap");
      const tgl = $("practiceToggle");
      const st = $("practiceStatus");
      if(!wrap || !tgl || !st) return;

      // ì´ë¬´ë§Œ ë…¸ì¶œ
      if(!state?.user || !state?.admin){
        wrap.classList.add("hidden");
        tgl.checked = false;
        st.textContent = "";
        return;
      }

      wrap.classList.remove("hidden");
      tgl.checked = !!PRACTICE_MODE;
      st.classList.remove("ok","warn","bad");
      if(PRACTICE_MODE){
        st.classList.add("ok");
        st.textContent = "ON (Demo)";
      } else {
        st.classList.add("muted");
        st.textContent = "OFF (ì‹¤ì œ)";
      }
    }

    // UI ì •ë¦¬: ì´ë¬´ì…ë ¥ í™”ë©´ì—ì„œ 'ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ ìƒì„±' ì¹´ë“œë¥¼ 'ì”ê³ /ì´ˆê¸°í™”' ë°”ë¡œ ìœ„ë¡œ ì´ë™
    (function reorderAdminCards(){
      const evCard = document.getElementById("adminEventCard");
      const resetCard = document.getElementById("adminResetCard");
      if(evCard && resetCard && resetCard.parentNode){
        resetCard.parentNode.insertBefore(evCard, resetCard);
      }
    })();

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 2600);
    }

    function escapeHtml(s){
      return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
    }

    function categoryLabel(cat){
      const map = {
        MONTHLY_FEE: "ì›”íšŒë¹„",
        CREDIT: "ì„ ìˆ˜ê¸ˆ",
        MEETING: "ì •ê¸°ëª¨ì„",
        SUMMER: "í•˜ê³„ì•¼ìœ íšŒ",
        CONDOLENCE: "ê²½ì¡°ì‚¬",
        CONDOLENCE_CONTRIB: "ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ / ê°¹ì¶œ",
        OTHER_INCOME: "ê¸°íƒ€ ìˆ˜ì…",
        YEAR_END: "ì†¡ë…„íšŒ",
        ETC: "ê¸°íƒ€"
      };
      return map[cat] || String(cat || "");
    }

    function normalizeName(name){
      return (name || "").trim().replace(/\s+/g, " ");
    }

    function fmtWon(n){
      return Number(n||0).toLocaleString("ko-KR") + "ì›";
    }

    function fmtDate(ts){
      if(!ts) return "";
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }

    function ymToNum(ym){
      const [y,m] = String(ym).split("-").map(Number);
      return y*100 + m;
    }

    function numToYm(n){
      const y = Math.floor(n/100);
      const m = String(n % 100).padStart(2, "0");
      return `${y}-${m}`;
    }

    function ymAddOne(ym){
      const [y,m] = ym.split("-").map(Number);
      const d = new Date(y, m-1, 1);
      d.setMonth(d.getMonth()+1);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
    }

    function ymRange(startYm, endYm){
      const out=[];
      let cur = startYm;
      const end = ymToNum(endYm);
      while(ymToNum(cur) <= end){
        out.push(cur);
        cur = ymAddOne(cur);
      }
      return out;
    }

    function isYm(s){
      return /^\d{4}-\d{2}$/.test(String(s||""));
    }

/*********************
 * Bì•ˆ) ì—°ë„ í•©ê³„(yearStats) ìºì‹œ
 *********************/
const yearStatsCache = new Map(); // year -> {inSum,outSum}
let yearStatsPermissionWarned = false;

function yearStatsRef(year){
  return doc(db, colName("yearStats"), String(year));
}

// âœ… yearStats ì½ê¸°(ìºì‹œ + ì•ˆì „ ì²˜ë¦¬)
async function loadYearStats(year, { force=false } = {}){
  const yNum = Number(year);
  if(!yNum) return { inSum:0, outSum:0 };
  const y = String(yNum);

  if(!force && yearStatsCache.has(y)) return yearStatsCache.get(y);

  try{
    const snap = await getDoc(yearStatsRef(y));
    const data = snap.exists() ? (snap.data() || {}) : {};
    const res = { inSum: Number(data.inSum||0), outSum: Number(data.outSum||0) };
    yearStatsCache.set(y, res);
    return res;
  } catch(e){
    console.error(e);
    if(!yearStatsPermissionWarned){
      yearStatsPermissionWarned = true;
      toast("ì—°ë„ í•©ê³„(yearStats) ê¶Œí•œì´ ì—†ì–´ í•©ê³„ë¥¼ 0ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤. (Firestore rules í™•ì¸ í•„ìš”)");
    }
    const res = { inSum:0, outSum:0 };
    yearStatsCache.set(y, res);
    return res;
  }
}


// âœ… (ì¤‘ìš”) yearStatsëŠ” 'ì§€ê¸ˆë¶€í„°' ëˆ„ì ì‹œí‚¤ëŠ” ìºì‹œë¼ì„œ,
// ê³¼ê±°ì— ì´ë¯¸ ì…ë ¥ë¼ ìˆë˜ ê±°ë˜ë“¤ì€ í•©ê³„ê°€ 0ìœ¼ë¡œ ë³´ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
// ì´ë¬´ê°€ ë¡œê·¸ì¸í–ˆì„ ë•Œ yearStatsê°€ ë¹„ì–´ ìˆìœ¼ë©´(0/0) í•´ë‹¹ ì—°ë„ë¥¼ 1íšŒ ì¬ê³„ì‚°í•´ ìë™ìœ¼ë¡œ ì±„ì›ë‹ˆë‹¤.
async function ensureYearStatsBuilt(year){
  const y = Number(year);
  const ys = await loadYearStats(y, { force:true });

  // ì´ë¯¸ ê°’ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
  if(Number(ys?.inSum||0) !== 0 || Number(ys?.outSum||0) !== 0) return ys;

  // ì´ë¬´ê°€ ì•„ë‹ˆë©´(íšŒì›) ìë™ ì¬ê³„ì‚°(ì“°ê¸°) ì‹œë„í•˜ì§€ ì•ŠìŒ
  if(!(state && state.admin)) return ys;

  try{
    const txs = await loadTransactionsForYear(y);
    if(!txs || txs.length === 0) return ys;

    const sums = calcSums(txs);
    await setDoc(yearStatsRef(y), { ...sums, rebuiltAt: Timestamp.now() }, { merge:true });
    yearStatsCache.set(String(y), sums);
    if(y === new Date().getFullYear()) state.yearStatsCurrent = sums;
    return sums;
  } catch(e){
    console.error(e);
    return ys;
  }
}

function bumpYearStatsInTxn(t, year, { inDelta=0, outDelta=0 } = {}){
  const ref = yearStatsRef(year);
  t.set(ref, {
    inSum: increment(Number(inDelta||0)),
    outSum: increment(Number(outDelta||0)),
    updatedAt: Timestamp.now()
  }, { merge:true });
}

function yearOf(ts){
  const d = ts?.toDate ? ts.toDate() : new Date(ts);
  return d.getFullYear();
}

function bumpYearStatsInBatch(batch, year, { inDelta=0, outDelta=0 } = {}){
  const ref = yearStatsRef(year);
  const payload = { updatedAt: Timestamp.now() };
  if(inDelta) payload.inSum = increment(Number(inDelta||0));
  if(outDelta) payload.outSum = increment(Number(outDelta||0));
  batch.set(ref, payload, { merge:true });
}

// í™”ë©´ ì¦‰ì‹œ ë°˜ì˜(ìºì‹œë„ ê°™ì´)
function bumpYearStatsLocal(year, { inDelta=0, outDelta=0 } = {}){
  const y = String(year);
  const base = yearStatsCache.get(y) || state.yearStatsCurrent || { inSum:0, outSum:0 };
  const next = {
    inSum: Number(base.inSum||0) + Number(inDelta||0),
    outSum: Number(base.outSum||0) + Number(outDelta||0),
  };
  yearStatsCache.set(y, next);
  if(String(new Date().getFullYear()) === y){
    state.yearStatsCurrent = next;
  }
}



    /*********************
     * 2) ê¶Œí•œ(ì´ë¬´ ì²´í¬)
     *********************/
    async function isAdmin(uid){
      const ref = doc(db, "roles", "admins");
      const snap = await getDoc(ref);
      if(!snap.exists()) return false;
      const uids = snap.data().uids || {};
      return uids[uid] === true;
    }

    /*********************
     * 3) ì„¤ì •(config)
     *********************/
    async function getConfig(){
      const ref = doc(db, "config", configDocId());
      const snap = await getDoc(ref);
      if(!snap.exists()){
        // ê¸°ë³¸ê°’ ìƒì„±
        const base = {
          openingYear: String(new Date().getFullYear()),
          openingBalance: 0,
          feeHistory: [
            { from: "2025-01", amount: 20000 }
          ]
        };
        await setDoc(ref, base);
        return base;
      }
      const c = snap.data();
      c.openingYear = String(c.openingYear || new Date().getFullYear());
      c.openingBalance = Number(c.openingBalance || 0);
      c.feeHistory = Array.isArray(c.feeHistory) ? c.feeHistory : [];
      return c;
    }

    function feeForMonth(feeHistory, ym){
      const target = ymToNum(ym);
      let best = null;
      for(const item of feeHistory){
        if(!item?.from) continue;
        if(ymToNum(item.from) <= target){
          if(!best || ymToNum(item.from) > ymToNum(best.from)) best = item;
        }
      }
      return best ? Number(best.amount || 0) : 0;
    }

    /*********************
     * 4) íšŒì›
     *********************/
    async function loadMembers(){
      const qy = query(collection(db, "members"), orderBy("name", "asc"));
      const snap = await getDocs(qy);
      const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      return list;
    }

    async function upsertMember({ name, activeFrom, activeTo }){
      const memberId = normalizeName(name);
      if(!memberId) throw new Error("ì´ë¦„ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.");
      if(activeFrom && !isYm(activeFrom)) throw new Error("í™œë™ ì‹œì‘ì›” í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      if(activeTo && !isYm(activeTo)) throw new Error("í™œë™ ì¢…ë£Œì›” í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");

      const ref = doc(db, "members", memberId);
      const snap = await getDoc(ref);

      if(!snap.exists()){
        await setDoc(ref, {
          name: memberId,
          activeFrom: activeFrom || "2024-01",
          activeTo: activeTo || null,
          exemptions: []
        });
      } else {
        await updateDoc(ref, {
          name: memberId,
          activeFrom: activeFrom || snap.data().activeFrom || "2024-01",
          activeTo: activeTo || null
        });
      }

      return memberId;
    }

    function isExempt(member, ym){
      const ex = Array.isArray(member.exemptions) ? member.exemptions : [];
      const t = ymToNum(ym);
      for(const it of ex){
        if(!it?.from || !it?.to) continue;
        if(ymToNum(it.from) <= t && t <= ymToNum(it.to)) return { yes:true, reason: it.reason || "" };
      }
      return { yes:false, reason:"" };
    }

    async function addExemption({ memberId, from, to, reason }){
      if(!memberId) throw new Error("íšŒì› ì„ íƒ í•„ìš”");
      if(!isYm(from) || !isYm(to)) throw new Error("ë©´ì œ ê¸°ê°„ì€ YYYY-MM í˜•ì‹");
      if(ymToNum(from) > ymToNum(to)) throw new Error("ë©´ì œ ì‹œì‘ì›”ì´ ì¢…ë£Œì›”ë³´ë‹¤ ëŠ¦ìŠµë‹ˆë‹¤.");

      const ref = doc(db, "members", memberId);
      const snap = await getDoc(ref);
      if(!snap.exists()) throw new Error("íšŒì›ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

      const member = snap.data();
      const arr = Array.isArray(member.exemptions) ? member.exemptions : [];
      arr.push({ from, to, reason: reason || "" });
      await updateDoc(ref, { exemptions: arr });
    }

    async function updateExemptionAt({ memberId, idx, from, to, reason }){
      if(!memberId) throw new Error("íšŒì› ì„ íƒ í•„ìš”");
      if(idx === null || idx === undefined || idx < 0) throw new Error("ìˆ˜ì • ëŒ€ìƒ(ì¸ë±ìŠ¤) ì—†ìŒ");
      if(!isYm(from) || !isYm(to)) throw new Error("ë©´ì œ ê¸°ê°„ì€ YYYY-MM í˜•ì‹");
      if(ymToNum(from) > ymToNum(to)) throw new Error("ë©´ì œ ì‹œì‘ì›”ì´ ì¢…ë£Œì›”ë³´ë‹¤ ëŠ¦ìŠµë‹ˆë‹¤.");

      const ref = doc(db, "members", memberId);
      const snap = await getDoc(ref);
      if(!snap.exists()) throw new Error("íšŒì›ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

      const member = snap.data();
      const arr = Array.isArray(member.exemptions) ? member.exemptions : [];
      if(idx >= arr.length) throw new Error("ë©´ì œ ìˆ˜ì • ì¸ë±ìŠ¤ê°€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤.");

      arr[idx] = { from, to, reason: reason || "" };
      await updateDoc(ref, { exemptions: arr });
    }

    async function removeExemptionAt({ memberId, idx }){
      if(!memberId) throw new Error("íšŒì› ì„ íƒ í•„ìš”");
      if(idx === null || idx === undefined || idx < 0) throw new Error("ì‚­ì œ ëŒ€ìƒ(ì¸ë±ìŠ¤) ì—†ìŒ");

      const ref = doc(db, "members", memberId);
      const snap = await getDoc(ref);
      if(!snap.exists()) throw new Error("íšŒì›ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

      const member = snap.data();
      const arr = Array.isArray(member.exemptions) ? member.exemptions : [];
      if(idx >= arr.length) throw new Error("ë©´ì œ ì‚­ì œ ì¸ë±ìŠ¤ê°€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤.");

      arr.splice(idx, 1);
      await updateDoc(ref, { exemptions: arr });
    }

    async function setMemberActiveTo({ memberId, activeTo }){
      if(!memberId) throw new Error("íšŒì›ID ì—†ìŒ");
      if(activeTo && !isYm(activeTo)) throw new Error("í™œë™ ì¢…ë£Œì›”ì€ YYYY-MM í˜•ì‹");
      const ref = doc(db, "members", memberId);
      const snap = await getDoc(ref);
      if(!snap.exists()) throw new Error("íšŒì›ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      await updateDoc(ref, { activeTo: activeTo || null });
    }

    /*********************
     * 5) memberPeriods ìƒì„±/ì¬ê³„ì‚°
     *********************/
    function inActive(member, ym){
      const t = ymToNum(ym);
      const from = member.activeFrom ? ymToNum(member.activeFrom) : ymToNum("1900-01");
      const to = member.activeTo ? ymToNum(member.activeTo) : ymToNum("2999-12");
      return from <= t && t <= to;
    }

    function mpId(memberId, periodId){
      return `${memberId}__${periodId}`;
    }

    async function ensureMemberPeriodsForRange({ member, startYm, endYm, recalc=false }){
      const config = await getConfig();
      const months = ymRange(startYm, endYm);

      for(const ym of months){
        if(!inActive(member, ym)) continue;

        const ex = isExempt(member, ym);
        const due = ex.yes ? 0 : feeForMonth(config.feeHistory, ym);
        const id = mpId(member.name, ym);
        const ref = doc(db, colName("memberPeriods"), id);
        const snap = await getDoc(ref);

        if(!snap.exists()){
          const paid = 0;
          const status = ex.yes ? "EXEMPT" : (due === 0 ? "PAID" : "UNPAID");
          await setDoc(ref, {
            memberId: member.name,
            periodId: ym,
            due,
            paid,
            exempt: ex.yes,
            exemptReason: ex.reason,
            status
          });
        } else if(recalc) {
          // due/ë©´ì œë§Œ ì¬ê³„ì‚°, paidëŠ” ìœ ì§€
          const cur = snap.data();
          const paid = Number(cur.paid || 0);
          let status;
          if(ex.yes) status = "EXEMPT";
          else if(due === 0) status = "PAID";
          else if(paid >= due) status = "PAID";
          else if(paid > 0) status = "PARTIAL";
          else status = "UNPAID";

          await updateDoc(ref, {
            due,
            exempt: ex.yes,
            exemptReason: ex.reason,
            status
          });
        }
      }
    }

    /*********************
     * 6) FIFO ìë™ë°°ì • + ì„ ìˆ˜ê¸ˆ
     *********************/
    async function allocateMonthlyFIFO({ memberId, txId, amount }){
      if(!memberId) throw new Error("memberId ì—†ìŒ");
      if(!txId) throw new Error("txId ì—†ìŒ");
      const amt = Number(amount || 0);
      if(!amt || amt <= 0) return;

      // âœ… ì¸ë±ìŠ¤ ì—†ì´ë„ ë™ì‘: memberIdë¡œ ì „ë¶€ ì½ê³ , JSì—ì„œ ë¯¸ë‚©/ë¶€ë¶„ë‚©ë§Œ ê³¨ë¼ ê¸°ê°„ìˆœ ì •ë ¬
      const allQ = query(
        collection(db, colName("memberPeriods")),
        where("memberId", "==", memberId)
      );
      const allSnap = await getDocs(allQ);

      const mpRefs = allSnap.docs
        .filter(d => {
          const st = d.data()?.status;
          return st === "UNPAID" || st === "PARTIAL";
        })
        .map(d => d.ref)
        .sort((a,b) => {
          const pa = a.id.split("__").pop();
          const pb = b.id.split("__").pop();
          return ymToNum(pa) - ymToNum(pb);
        });

      const txRef = doc(db, colName("transactions"), txId);
      const creditRef = doc(db, colName("credits"), memberId);

      await runTransaction(db, async (t) => {
        // âœ… Firestore íŠ¸ëœì­ì…˜ ê·œì¹™: ëª¨ë“  ì½ê¸° â†’ ëª¨ë“  ì“°ê¸°
        const txSnap = await t.get(txRef);
        if(!txSnap.exists()) throw new Error("ê±°ë˜(tx)ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");

        const mpSnaps = mpRefs.length ? await Promise.all(mpRefs.map(r => t.get(r))) : [];
        const creditSnap = await t.get(creditRef);

        let remaining = amt;
        const now = Timestamp.now();

        // (1) ì›”íšŒë¹„ FIFO ë°°ì •: ë¯¸ë‚©/ë¶€ë¶„ë‚© ì›”ë¶€í„°
        for(let i=0; i<mpRefs.length && remaining>0; i++){
          const snap = mpSnaps[i];
          if(!snap.exists()) continue;
          const mp = snap.data();
          if(mp.exempt) continue;

          const due = Number(mp.due || 0);
          const paid = Number(mp.paid || 0);
          const need = Math.max(0, due - paid);
          if(need <= 0) continue;

          const use = Math.min(remaining, need);
          const newPaid = paid + use;
          const newStatus = (newPaid >= due) ? "PAID" : "PARTIAL";

          t.update(mpRefs[i], { paid: newPaid, status: newStatus });

          const allocRef = doc(collection(db, colName("allocations")));
          t.set(allocRef, {
            txId,
            memberId,
            targetType: "PERIOD",
            targetId: mp.periodId,
            periodId: mp.periodId,
            amount: use,
            createdAt: now
          });

          remaining -= use;
        }

        // (2) ë‚¨ëŠ” ëˆì€ ì„ ìˆ˜ê¸ˆ(í¬ë ˆë”§)
        if(remaining > 0){
          const cur = creditSnap.exists() ? Number(creditSnap.data().balance || 0) : 0;
          t.set(creditRef, { balance: cur + remaining }, { merge:true });

          const allocRef = doc(collection(db, colName("allocations")));
          t.set(allocRef, {
            txId,
            memberId,
            targetType: "CREDIT",
            targetId: memberId,
            amount: remaining,
            createdAt: now
          });
        }
      });
    }

    async function loadTransactions(){
      const qy = query(collection(db, colName("transactions")), orderBy("date", "desc"), limit(120));
      const snap = await getDocs(qy);
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function loadTransactionsForYear(year){
      const y = Number(year);
      const start = Timestamp.fromDate(new Date(y, 0, 1, 0, 0, 0));
      const end = Timestamp.fromDate(new Date(y+1, 0, 1, 0, 0, 0));

      const qy = query(
        collection(db, colName("transactions")),
        where("date", ">=", start),
        where("date", "<", end),
        orderBy("date", "desc"),
        limit(1500)
      );
      const snap = await getDocs(qy);
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    /*********************
     * 6.3) ê±°ë˜ ì‚­ì œ(ì •ì •): ë°°ì •/ì„ ìˆ˜ê¸ˆ/ê²½ì¡°ì‚¬ ì§‘ê³„ ë˜ëŒë¦¬ê¸°
     *********************/
    async function deleteTransactionWithRollback(txId){
      if(!state.admin) throw new Error("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      if(!txId) throw new Error("txId ì—†ìŒ");

      // âœ… tx/allocationsëŠ” íŠ¸ëœì­ì…˜ ë°–ì—ì„œ ì½ì–´ë‘¡ë‹ˆë‹¤(ê·œì¹™ + ì„±ëŠ¥)
      const txRef = doc(db, colName("transactions"), txId);
      const txSnap = await getDoc(txRef);
      if(!txSnap.exists()) throw new Error("ê±°ë˜ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      const tx = { id: txSnap.id, ...txSnap.data() };

      // ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ ìƒì„± ì‹œ ìë™ ìƒì„±ëœ ì„ ì§€ì¶œ(OUT)ì€ ì‚­ì œ ê¸ˆì§€(ì´ë²¤íŠ¸ êµ¬ì¡°ê°€ ê¹¨ì§)
      if(tx.type === "OUT" && tx.category === "CONDOLENCE" && tx.eventId && String(tx.memo||"").includes("[ê²½ì¡°ì‚¬ ì„ ì§€ì¶œ]")){
        throw new Error(`ì´ ê±°ë˜ëŠ” 'ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ ìƒì„±'ìœ¼ë¡œ ìë™ ìƒì„±ëœ ì„ ì§€ì¶œì…ë‹ˆë‹¤.
ì´ë²¤íŠ¸ ê¸°ë¡ê³¼ ì—°ê²°ë¼ ìˆì–´ ì‚­ì œë¥¼ ë§‰ì•„ë‘ì—ˆìŠµë‹ˆë‹¤.`);
      }

      const allocQ = query(collection(db, colName("allocations")), where("txId", "==", txId));
      const allocSnap = await getDocs(allocQ);
      const allocDocs = allocSnap.docs.map(d => ({ ref:d.ref, data:d.data() }));

      const memberId = tx.memberId || tx.memberName || null;
      const creditRef = memberId ? doc(db, colName("credits"), memberId) : null;

      // ì›”íšŒë¹„(PERIOD) ë˜ëŒë¦¼ ì¤€ë¹„
      const periodAllocs = allocDocs
        .filter(a => a.data?.targetType === "PERIOD")
        .map(a => ({
          memberId: a.data?.memberId || memberId,
          periodId: a.data?.targetId,
          amount: Number(a.data?.amount || 0)
        }))
        .filter(x => x.memberId && x.periodId && x.amount > 0);

      // credit(ì„ ìˆ˜ê¸ˆ) ë˜ëŒë¦¼ ì¤€ë¹„: allocations ê¸°ì¤€(ê°€ì¥ ì‹ ë¢°)
      const creditFromAlloc = allocDocs
        .filter(a => a.data?.targetType === "CREDIT")
        .reduce((s,a)=> s + Number(a.data?.amount || 0), 0);

      // ê²½ì¡°ì‚¬(EVENT) ë˜ëŒë¦¼ ì¤€ë¹„
      const eventAlloc = allocDocs.find(a => a.data?.targetType === "EVENT");
      const eventApplied = Number(eventAlloc?.data?.amount || tx.eventAppliedAmount || 0);

      const txYear = yearOf(tx.date);

      await runTransaction(db, async (t) => {
        // âœ… Firestore íŠ¸ëœì­ì…˜ ê·œì¹™: ëª¨ë“  ì½ê¸° â†’ ëª¨ë“  ì“°ê¸°

        // 1) refs ìˆ˜ì§‘(ì¤‘ë³µ ì œê±°)
        const mpRefMap = new Map();
        for(const it of periodAllocs){
          const id = `${it.memberId}__${it.periodId}`;
          if(!mpRefMap.has(id)) mpRefMap.set(id, doc(db, colName("memberPeriods"), id));
        }
        const mpRefs = [...mpRefMap.values()];

        let eventRef = null;
        let emRef = null;
        if(tx.type === "IN" && tx.category === "CONDOLENCE_CONTRIB"){
          if(!tx.eventId) throw new Error("ì´ ê±°ë˜ëŠ” ê²½ì¡°ì‚¬ ë‚©ë¶€ì¸ë° eventIdê°€ ì—†ìŠµë‹ˆë‹¤.");
          if(!memberId) throw new Error("ì´ ê±°ë˜ëŠ” ê²½ì¡°ì‚¬ ë‚©ë¶€ì¸ë° memberIdê°€ ì—†ìŠµë‹ˆë‹¤.");
          eventRef = doc(db, colName("events"), tx.eventId);
          emRef = doc(db, colName("eventMembers"), `${tx.eventId}__${memberId}`);
        }

        // 2) âœ… ì½ê¸°
        const mpSnaps = mpRefs.length ? await Promise.all(mpRefs.map(r => t.get(r))) : [];
        const mpSnapById = new Map();
        mpRefs.forEach((r, i) => mpSnapById.set(r.id, mpSnaps[i]));

        const creditSnap = creditRef ? await t.get(creditRef) : null;
        const evSnap = eventRef ? await t.get(eventRef) : null;
        const emSnap = emRef ? await t.get(emRef) : null;

        // 3) âœ… ì“°ê¸°
        if(tx.type === "IN"){
          // (A) ì›”íšŒë¹„: PERIOD paid ë˜ëŒë¦¬ê¸° + ë‚¨ì€ ì„ ìˆ˜ê¸ˆ ë˜ëŒë¦¬ê¸°
          if(tx.category === "MONTHLY_FEE"){
            for(const it of periodAllocs){
              const id = `${it.memberId}__${it.periodId}`;
              const mpRef = doc(db, colName("memberPeriods"), id);
              const snap = mpSnapById.get(mpRef.id);
              if(!snap || !snap.exists()) continue;
              const mp = snap.data();
              if(mp.exempt) continue;

              const due = Number(mp.due||0);
              const paid = Number(mp.paid||0);
              const dec = Number(it.amount||0);

              const newPaid = Math.max(0, paid - dec);
              let newStatus;
              if(mp.exempt) newStatus = "EXEMPT";
              else if(due === 0) newStatus = "PAID";
              else if(newPaid >= due) newStatus = "PAID";
              else if(newPaid > 0) newStatus = "PARTIAL";
              else newStatus = "UNPAID";

              t.update(mpRef, { paid:newPaid, status:newStatus });
            }

            if(creditFromAlloc > 0 && creditRef){
              const cur = creditSnap && creditSnap.exists() ? Number(creditSnap.data().balance || 0) : 0;
              t.set(creditRef, { balance: Math.max(0, cur - creditFromAlloc) }, { merge:true });
            }
          }

          // (B) ì„ ìˆ˜ê¸ˆë§Œ ì ë¦½(IN: CREDIT)
          if(tx.category === "CREDIT"){
            if(creditRef){
              const cur = creditSnap && creditSnap.exists() ? Number(creditSnap.data().balance || 0) : 0;
              t.set(creditRef, { balance: Math.max(0, cur - Number(tx.amount||0)) }, { merge:true });
            }
          }

          // (C) ê²½ì¡°ì‚¬ ë‚©ë¶€(IN: CONDOLENCE_CONTRIB)
          if(tx.category === "CONDOLENCE_CONTRIB"){
            if(!evSnap || !evSnap.exists()) throw new Error("ì´ë²¤íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            if(!emSnap || !emSnap.exists()) throw new Error("ì´ë²¤íŠ¸ ë©¤ë²„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");

            const ev = evSnap.data();
            const em = emSnap.data();

            const use = eventApplied;
            const extra = creditFromAlloc || Number(tx.creditAddedAmount || 0);

            const due = Number(em.due||0);
            const paid = Number(em.paid||0);
            const prevStatus = em.status || (paid >= due ? "PAID" : (paid>0?"PARTIAL":"UNPAID"));

            const newPaid = Math.max(0, paid - use);
            let newStatus;
            if(newPaid >= due) newStatus = "PAID";
            else if(newPaid > 0) newStatus = "PARTIAL";
            else newStatus = "UNPAID";

            t.update(emRef, { paid:newPaid, status:newStatus });

            let paidSum = Number(ev.paidSum || 0);
            paidSum = Math.max(0, paidSum - use);

            let unpaidCount = Number(ev.unpaidCount || 0);
            if(prevStatus === "PAID" && newStatus !== "PAID") unpaidCount = unpaidCount + 1;

            const newEventStatus = (unpaidCount === 0) ? "CLOSED" : "OPEN";
            t.update(eventRef, { paidSum, unpaidCount, status:newEventStatus, updatedAt: Timestamp.now() });

            if(extra > 0 && creditRef){
              const cur = creditSnap && creditSnap.exists() ? Number(creditSnap.data().balance || 0) : 0;
              t.set(creditRef, { balance: Math.max(0, cur - extra) }, { merge:true });
            }
          }
        }

        // âœ… yearStats ë˜ëŒë¦¬ê¸°(ê±°ë˜ ì‚­ì œ ë°˜ì˜)
        if(tx.type === "IN") bumpYearStatsInTxn(t, txYear, { inDelta: -Number(tx.amount||0) });
        else if(tx.type === "OUT") bumpYearStatsInTxn(t, txYear, { outDelta: -Number(tx.amount||0) });

        // allocations ì‚­ì œ
        for(const a of allocDocs){
          t.delete(a.ref);
        }

        // ê±°ë˜ ì‚­ì œ
        t.delete(txRef);
      });
    }

    $("btnTxDelete")?.addEventListener("click", async () => {
      if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      const txId = txLongPressTargetId;
      if(!txId) return;

      const ok = confirm(`ì´ ê±°ë˜ë¥¼ ì‚­ì œ(ì •ì •)í• ê¹Œìš”?

- ì‚­ì œëŠ” ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
- ì›”íšŒë¹„/ê²½ì¡°ì‚¬ ë‚©ë¶€ëŠ” ê´€ë ¨ ë°°ì •/ì„ ìˆ˜ê¸ˆ/ì§‘ê³„ë„ í•¨ê»˜ ë˜ëŒë¦½ë‹ˆë‹¤.`);
      if(!ok) return;

      try{
        toast("ì‚­ì œ ì²˜ë¦¬ ì¤‘...");
        await deleteTransactionWithRollback(txId);
        toast("ì‚­ì œ ì™„ë£Œ");
        closeTxActionOverlay();
        await refreshAll();
        setTab("dashboard");
      } catch(e){
        alert(e?.message || String(e));
        console.error(e);
      }
    });

    /*********************
     * 6.7) ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ / ê°¹ì¶œ
     *********************/
    function eventMemberDocId(eventId, memberId){
      return `${eventId}__${memberId}`;
    }

    async function loadEvents(){
      const qy = query(collection(db, colName("events")), orderBy("date", "desc"), limit(60));
      const snap = await getDocs(qy);
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function loadEventMembers(eventId){
      const qy = query(collection(db, colName("eventMembers")), where("eventId","==",eventId));
      const snap = await getDocs(qy);
      const rows = snap.docs.map(d => d.data());
      rows.sort((a,b)=> String(a.memberId||"").localeCompare(String(b.memberId||""), "ko"));
      return rows;
    }

    const eventMembersCache = new Map(); // eventId -> rows

    function fillEventSelects(){
      const el = $("inEvent");
      if(!el) return;
      const empty = `<option value="">(ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ ì„ íƒ)</option>`;
      const openEvents = (state.events || []).filter(e => (e.status || "OPEN") !== "CLOSED");
      const opts = openEvents.map(e => {
        const title = e.title || "ê²½ì¡°ì‚¬";
        const target = e.targetMemberName ? ` / ë‹¹ì‚¬ì:${e.targetMemberName}` : "";
        return `<option value="${escapeHtml(e.id)}">${escapeHtml(title)}${escapeHtml(target)}</option>`;
      }).join("");
      el.innerHTML = empty + opts;
    }

    function renderEventList(){
      const box = $("eventList");
      if(!box) return;

      const list = state.events || [];
      if(list.length === 0){
        box.innerHTML = `<div class="muted">ë“±ë¡ëœ ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      box.innerHTML = list.map(ev => {
        const title = ev.title || "ê²½ì¡°ì‚¬";
        const target = ev.targetMemberName || "";
        const per = Number(ev.perPersonAmount || 0);
        const total = Number(ev.totalDue || 0);
        const paid = Number(ev.paidSum || 0);
        const unpaidCount = Number(ev.unpaidCount || 0);
        const pct = total > 0 ? Math.max(0, Math.min(100, Math.round((paid/total)*100))) : 0;
        const st = (ev.status || "OPEN") === "CLOSED"
          ? `<span class="ok">ì™„ë£Œ</span>`
          : `<span class="warn">ì§„í–‰ì¤‘</span>`;

        return `
          <div class="eventBox">
            <div class="split">
              <div class="row" style="gap:8px;">
                <b>${escapeHtml(title)}</b>
                <span class="pill">ë‹¹ì‚¬ì: ${escapeHtml(target)}</span>
                <span class="pill">1ì¸ ${fmtWon(per)}</span>
                <span class="pill">${st}</span>
              </div>
              <div class="muted">${fmtDate(ev.date)}</div>
            </div>
            <div class="progress" style="margin-top:10px;"><div style="width:${pct}%;"></div></div>
            <div class="row" style="margin-top:10px; justify-content:space-between;">
              <div class="muted tiny">ëª¨ê¸ˆ ${fmtWon(paid)} / ${fmtWon(total)} Â· ë¯¸ë‚© ${unpaidCount}ëª…</div>
              <button class="linkBtn tiny" data-action="toggleEvent" data-id="${escapeHtml(ev.id)}">ìì„¸íˆ ë³´ê¸°</button>
            </div>
            <div id="evDetail-${escapeHtml(ev.id)}" class="hidden" style="margin-top:10px;"></div>
          </div>
        `;
      }).join("");
    }

    async function refreshEvents(){
      state.events = await loadEvents();
      fillEventSelects();
      renderEventList();
    }

    async function createCondolenceEvent({ title, targetMemberId, excludedMemberIds = [], perPersonAmount, dateStr, memo }){
      if(!state.admin) throw new Error("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      if(!targetMemberId) throw new Error("ê²½ì¡°ì‚¬ ë‹¹ì‚¬ì(ë³¸ì¸) ì„ íƒ í•„ìš”");
      const per = Number(perPersonAmount || 0);
      if(!per || per <= 0) throw new Error("1ì¸ë‹¹ ê°¹ì¶œ ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”.");
      if(!dateStr) throw new Error("ë‚ ì§œ ì„ íƒ í•„ìš”");

      const ym = String(dateStr).slice(0,7);
      if(!isYm(ym)) throw new Error("ë‚ ì§œ í˜•ì‹ ì˜¤ë¥˜");

      const excludesArr = Array.isArray(excludedMemberIds) ? excludedMemberIds : [];
      const excludeSet = new Set(excludesArr.filter(x => x && x !== targetMemberId));

      const participants = (state.members || [])
        .filter(m => inActive(m, ym))
        .map(m => m.name)
        .filter(n => n && n !== targetMemberId && !excludeSet.has(n));

      if(participants.length === 0) throw new Error("ê°¹ì¶œ ëŒ€ìƒ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.");

      const excludedFinal = [...excludeSet];
      const totalDue = per * participants.length;
      const [y,m,d] = dateStr.split("-").map(Number);
      const date = Timestamp.fromDate(new Date(y, m-1, d, 12, 0, 0));

      const batch = writeBatch(db);
      const eventRef = doc(collection(db, colName("events")));
      const payoutTxRef = doc(collection(db, colName("transactions")));

      batch.set(eventRef, {
        type: "CONDOLENCE",
        title: (title || "ê²½ì¡°ì‚¬").trim(),
        targetMemberId,
        targetMemberName: targetMemberId,
        excludedMemberIds: excludedFinal,
        excludedCount: excludedFinal.length,
        perPersonAmount: per,
        participantCount: participants.length,
        participants,
        totalDue,
        paidSum: 0,
        unpaidCount: participants.length,
        status: "OPEN",
        memo: memo || "",
        date,
        payoutTxId: payoutTxRef.id,
        createdByUid: state.user.uid,
        createdAt: Timestamp.now()
      });

      // âœ… ì„ ì§€ì¶œ(OUT): ì´ì•¡(ë‹¹ì‚¬ì ì œì™¸ ì¸ì› * 1ì¸ë‹¹ ê¸ˆì•¡)
      const exclText = excludedFinal.length ? ` / ì œì™¸:${excludedFinal.join(",")}` : "";
      const payoutMemo = `[ê²½ì¡°ì‚¬ ì„ ì§€ì¶œ] ${title || "ê²½ì¡°ì‚¬"} / ë‹¹ì‚¬ì:${targetMemberId}${exclText}${memo?`
${memo}`:""}`;
      batch.set(payoutTxRef, {
        type: "OUT",
        category: "CONDOLENCE",
        amount: totalDue,
        memo: payoutMemo,
        date,
        targetMemberId,
        targetMemberName: targetMemberId,
        eventId: eventRef.id,
        eventTitle: (title || "ê²½ì¡°ì‚¬").trim(),
        createdByUid: state.user.uid,
        createdAt: Timestamp.now()
      });

      bumpYearStatsInBatch(batch, yearOf(date), { outDelta: totalDue });


      // âœ… íšŒì›ë³„ ê°¹ì¶œ(ë¯¸ë‚©) ìƒì„±
      for(const memberId of participants){
        const emRef = doc(db, colName("eventMembers"), eventMemberDocId(eventRef.id, memberId));
        batch.set(emRef, {
          eventId: eventRef.id,
          memberId,
          due: per,
          paid: 0,
          status: "UNPAID",
          createdAt: Timestamp.now()
        });
      }

      await batch.commit();
      eventMembersCache.delete(eventRef.id);
      return eventRef.id;
    }

    async function payEventContribution({ eventId, memberId, amount, memo, dateStr }){
      if(!state.admin) throw new Error("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      if(!eventId) throw new Error("ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ ì„ íƒ í•„ìš”");
      if(!memberId) throw new Error("ì…ê¸ˆì ì„ íƒ í•„ìš”");
      const amt = Number(amount || 0);
      if(!amt || amt <= 0) throw new Error("ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”.");
      if(!dateStr) throw new Error("ë‚ ì§œ ì„ íƒ í•„ìš”");

      const [y,m,d] = dateStr.split("-").map(Number);
      const date = Timestamp.fromDate(new Date(y, m-1, d, 12, 0, 0));

      const eventRef = doc(db, colName("events"), eventId);
      const emRef = doc(db, colName("eventMembers"), eventMemberDocId(eventId, memberId));
      const creditRef = doc(db, colName("credits"), memberId);

      const txRef = doc(collection(db, colName("transactions")));
      const allocEventRef = doc(collection(db, colName("allocations")));
      const allocCreditRef = doc(collection(db, colName("allocations")));

      await runTransaction(db, async (t) => {
        const evSnap = await t.get(eventRef);
        if(!evSnap.exists()) throw new Error("ì´ë²¤íŠ¸ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        const ev = evSnap.data();
        if((ev.status || "OPEN") === "CLOSED") throw new Error("ì´ë¯¸ ì¢…ë£Œëœ ì´ë²¤íŠ¸ì…ë‹ˆë‹¤.");

        const emSnap = await t.get(emRef);
        if(!emSnap.exists()) throw new Error("ì´ ì´ë²¤íŠ¸ ê°¹ì¶œ ëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤. (ë‹¹ì‚¬ìëŠ” ìë™ ì œì™¸)");

        // âœ… Firestore íŠ¸ëœì­ì…˜ ê·œì¹™: ëª¨ë“  ì½ê¸° â†’ ëª¨ë“  ì“°ê¸° (ì„ ìˆ˜ê¸ˆ ë¬¸ì„œëŠ” ì—¬ê¸°ì„œ ë¯¸ë¦¬ ì½ì–´ë‘¡ë‹ˆë‹¤)
        const creditSnap = await t.get(creditRef);
        const em = emSnap.data();
        const due = Number(em.due || 0);
        const paid = Number(em.paid || 0);
        const remain = Math.max(0, due - paid);
        if(remain <= 0) throw new Error("ì´ë¯¸ ë‚©ë¶€ ì™„ë£Œëœ íšŒì›ì…ë‹ˆë‹¤.");

        const use = Math.min(amt, remain);
        const extra = Math.max(0, amt - use);

        const newPaid = paid + use;
        const newStatus = (newPaid >= due) ? "PAID" : "PARTIAL";
        t.update(emRef, { paid: newPaid, status: newStatus });

        // ì´ë²¤íŠ¸ ì§‘ê³„ ì—…ë°ì´íŠ¸
        let unpaidCount = Number(ev.unpaidCount || 0);
        let paidSum = Number(ev.paidSum || 0);
        paidSum += use;
        if((em.status === "UNPAID" || em.status === "PARTIAL") && newStatus === "PAID") unpaidCount = Math.max(0, unpaidCount - 1);
        const newEventStatus = (unpaidCount === 0) ? "CLOSED" : (ev.status || "OPEN");
        t.update(eventRef, { paidSum, unpaidCount, status: newEventStatus, updatedAt: Timestamp.now() });

        // ê±°ë˜ ê¸°ë¡(IN): ì‹¤ì œ ì…ê¸ˆì•¡ì€ ê·¸ëŒ€ë¡œ ê¸°ë¡
        t.set(txRef, {
          type: "IN",
          category: "CONDOLENCE_CONTRIB",
          amount: amt,
          memberId,
          memberName: memberId,
          memo: memo || "",
          date,
          eventId,
          eventTitle: ev.title || "ê²½ì¡°ì‚¬",
          targetMemberId: ev.targetMemberId || null,
          targetMemberName: ev.targetMemberName || null,
          eventAppliedAmount: use,
          creditAddedAmount: extra,
          createdByUid: state.user.uid,
          createdAt: Timestamp.now()
        });

        bumpYearStatsInTxn(t, yearOf(date), { inDelta: amt });


        // ë°°ì •(ì´ë²¤íŠ¸)
        t.set(allocEventRef, {
          txId: txRef.id,
          memberId,
          targetType: "EVENT",
          targetId: eventId,
          amount: use,
          createdAt: Timestamp.now()
        });

        // ì”ì—¬ëŠ” ì„ ìˆ˜ê¸ˆìœ¼ë¡œ
        if(extra > 0){
          const cSnap = creditSnap;
          const cur = cSnap.exists() ? Number(cSnap.data().balance || 0) : 0;
          t.set(creditRef, { balance: cur + extra }, { merge:true });
          t.set(allocCreditRef, {
            txId: txRef.id,
            memberId,
            targetType: "CREDIT",
            targetId: memberId,
            amount: extra,
            createdAt: Timestamp.now()
          });
        }
      });

      bumpYearStatsLocal(yearOf(date), { inDelta: amt });


      eventMembersCache.delete(eventId);
    }

    /*********************
     * 7) ì”ê³ (ê¸°ì´ˆ ì”ê³  + ì…ê¸ˆ - ì§€ì¶œ)
     *********************/
    function calcSums(txList){
      let inSum = 0;
      let outSum = 0;
      for(const tx of txList || []){
        const amt = Number(tx.amount || 0);
        if(tx.type === "IN") inSum += amt;
        else if(tx.type === "OUT") outSum += amt;
      }
      return { inSum, outSum };
    }

    function renderBalance(){
      const year = new Date().getFullYear();
      const opening = Number(cachedConfig?.openingBalance || 0);
      const ys = state.yearStatsCurrent || { inSum:0, outSum:0 };
      const inSum = Number(ys.inSum || 0);
      const outSum = Number(ys.outSum || 0);
      const balance = opening + inSum - outSum;

      if($("yearPill")) $("yearPill").textContent = `${year}ë…„`;
      if($("balanceHint")) $("balanceHint").textContent = `${year}ë…„ í˜„ì¬ ì”ê³ (ê¸°ì´ˆ ì”ê³  + ${year}ë…„ ì…ê¸ˆ - ${year}ë…„ ì§€ì¶œ)`;
      if($("openingTitle")) $("openingTitle").textContent = `${year}ë…„ ê¸°ì´ˆ ì”ê³ (1/1)`;
      if($("inSumTitle")) $("inSumTitle").textContent = `${year}ë…„ ì…ê¸ˆ í•©ê³„`;
      if($("outSumTitle")) $("outSumTitle").textContent = `${year}ë…„ ì§€ì¶œ í•©ê³„`;

      if($("balanceBig")) $("balanceBig").textContent = fmtWon(balance);
      if($("openingLabel")) $("openingLabel").textContent = fmtWon(opening);
      if($("inSumLabel")) $("inSumLabel").textContent = fmtWon(inSum);
      if($("outSumLabel")) $("outSumLabel").textContent = fmtWon(outSum);
      if($("openingBalance")) $("openingBalance").value = String(opening || 0);
    }

    // âœ… í•´ê°€ ë°”ë€Œë©´ ìë™ìœ¼ë¡œ 'ì „ë…„ë„ ê¸°ë§ ì”ê³ 'ë¥¼ ìƒˆí•´ ê¸°ì´ˆ ì”ê³ ë¡œ ì´ì›”
    async function ensureOpeningForCurrentYear(){
      const nowYear = new Date().getFullYear();
      let cfgYear = Number(cachedConfig?.openingYear || nowYear);
      let opening = Number(cachedConfig?.openingBalance || 0);

      // openingYearê°€ ê³¼ê±°ë©´, ê·¸ í•´ë“¤ì˜ 'ê¸°ë§ ì”ê³ 'ë¥¼ ìˆœì°¨ ê³„ì‚°í•´ ìƒˆí•´ ê¸°ì´ˆë¡œ ë„˜ê¹ë‹ˆë‹¤.
      while(cfgYear < nowYear){
        const prevTx = await loadTransactionsForYear(cfgYear);
        const { inSum, outSum } = calcSums(prevTx);
        opening = opening + inSum - outSum; // cfgYearì˜ ê¸°ë§ ì”ê³ 
        cfgYear += 1;
      }

      if(String(cachedConfig.openingYear) !== String(nowYear) || Number(cachedConfig.openingBalance) !== Number(opening)){
        const ref = doc(db, "config", configDocId());
        await setDoc(ref, { openingYear: String(nowYear), openingBalance: opening }, { merge:true });
        cachedConfig.openingYear = String(nowYear);
        cachedConfig.openingBalance = opening;
      }
    }

    async function wipeCollection(colName){
      // ê°œë°œ/í…ŒìŠ¤íŠ¸ìš© ì´ˆê¸°í™”: ë¬¸ì„œë¥¼ ë°°ì¹˜ë¡œ ì‚­ì œ
      let last = null;
      while(true){
        const base = [collection(db, colName), orderBy("__name__"), limit(450)];
        const qy = last ? query(...base, startAfter(last)) : query(...base);
        const snap = await getDocs(qy);
        if(snap.empty) break;

        const batch = writeBatch(db);
        snap.docs.forEach(d => batch.delete(d.ref));
        await batch.commit();
        last = snap.docs[snap.docs.length - 1];
      }
    }

    async function resetMoneyData(){
      if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      const ok = confirm(`[ê°œë°œ/í…ŒìŠ¤íŠ¸ìš©]
íšŒì› ì •ë³´ëŠ” ìœ ì§€í•˜ê³ , ê¸ˆì•¡/ê±°ë˜ ê´€ë ¨ ë°ì´í„°ë§Œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.

ì‚­ì œ ëŒ€ìƒ:
- ê±°ë˜ë‚´ì—­(transactions)
- ë°°ì •ë‚´ì—­(allocations)
- ì„ ìˆ˜ê¸ˆ(credits)
- ì›”ì²­êµ¬(memberPeriods)
- ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸(events)
- ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ ëŒ€ìƒ(eventMembers)
- íšŒë¹„ ì„¤ì •(config.main.feeHistory)

ê¸°ì´ˆ ì”ê³ (openingBalance)ëŠ” 0ìœ¼ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.

ì§„í–‰í• ê¹Œìš”?`);
      if(!ok) return;

      toast("ì´ˆê¸°í™” ì¤‘...");
      await wipeCollection(colName("transactions"));
      await wipeCollection(colName("allocations"));
      await wipeCollection(colName("credits"));
      await wipeCollection(colName("memberPeriods"));
      // âœ… ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ë„ ê¸ˆì•¡ ë°ì´í„°ì— í¬í•¨(í…ŒìŠ¤íŠ¸ìš©)
      await wipeCollection(colName("eventMembers"));
      await wipeCollection(colName("events"));
      eventMembersCache.clear();

      const ref = doc(db, "config", configDocId());
      await setDoc(ref, { openingYear: String(new Date().getFullYear()), openingBalance: 0, feeHistory: [] }, { merge:true });

      toast("ì´ˆê¸°í™” ì™„ë£Œ (íšŒë¹„ ì„¤ì •/ì›” ìƒì„±ì€ ë‹¤ì‹œ í•´ì£¼ì„¸ìš”)");
      await refreshAll();
      setTab("dashboard");
    }

    let txDisplayLimit = 30;

    /*********************
     * 7.9) ê±°ë˜ë‚´ì—­ ë³´ê¸° ëª¨ë“œ(ìµœê·¼ 120 / ì—°ë„ë³„)
     *********************/
    let txViewMode = "RECENT";                 // RECENT | YEAR
    let txViewYear = new Date().getFullYear();  // YEAR ëª¨ë“œì¼ ë•Œ ì„ íƒ ì—°ë„
    let txTypeFilter = "ALL";                 // ALL | IN | OUT (ì—°ë„ë³„ì—ì„œë§Œ ë…¸ì¶œ)
    let txShowMonthSum = true;                 // ì—°ë„ë³„ ì›”ë³„ í•©ê³„ ì¤„ í‘œì‹œ
    const txYearCache = new Map();              // year -> tx[]

    function fillTxYearSelect(){
      const el = $("txYearSelect");
      if(!el) return;
      const nowY = new Date().getFullYear();
      const years = [];
      for(let y=nowY; y>=nowY-6; y--) years.push(y);
      el.innerHTML = years.map(y => `<option value="${y}">${y}ë…„</option>`).join("");
      // ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ê¸°ë³¸ê°’ ì„¸íŒ…
      if(!el.value) el.value = String(txViewYear);
      txViewYear = Number(el.value || nowY);
    }

    function updateTxViewBadge(){
      const badge = $("txViewBadge");
      if(!badge) return;
      if(txViewMode === "RECENT"){
        badge.classList.add("hidden");
        badge.textContent = "";
        return;
      }
      badge.classList.remove("hidden");
      badge.textContent = `${txViewYear}ë…„ ì „ì²´`;
    }

    function syncTxViewControls(){
      const modeEl = $("txViewMode");
      const yearEl = $("txYearSelect");
      const typeEl = $("txTypeFilter");
      const msWrap = $("txMonthSumWrap");
      const msEl = $("txMonthSum");

      if(modeEl) modeEl.value = txViewMode;
      if(yearEl) yearEl.classList.toggle("hidden", txViewMode !== "YEAR");

      // ì—°ë„ë³„ì—ì„œë§Œ: ì…ê¸ˆ/ì§€ì¶œ í•„í„° + ì›”ë³„ í•©ê³„ í† ê¸€
      if(typeEl) typeEl.classList.toggle("hidden", txViewMode !== "YEAR");
      if(msWrap) msWrap.classList.toggle("hidden", txViewMode !== "YEAR");

      if(typeEl) typeEl.value = txTypeFilter;
      if(msEl) msEl.checked = !!txShowMonthSum;

      updateTxViewBadge();
    }

    function getTxViewList(){
      if(txViewMode === "RECENT") return state.tx || [];
      const y = Number(txViewYear);
      return txYearCache.get(y) || [];
    }

    async function loadTxYearView(year, { force=false } = {}){
      const y = Number(year);
      if(!y) return;
      if(!force && txYearCache.has(y)) return;
      const list = await loadTransactionsForYear(y);
      txYearCache.set(y, list);
    }

    async function applyTxView({ force=false } = {}){
      if(txViewMode === "YEAR"){
        const y = Number(txViewYear);
        if(force || !txYearCache.has(y)) await loadTxYearView(y, { force:true });
      }
      renderTxList(getTxViewList());
      updateTxViewBadge();
    }

    function renderTxList(list){
      const keyword = ($("txFilter")?.value || "").trim().toLowerCase();

      // 1) íƒ€ì… í•„í„°(ì—°ë„ë³„ì—ì„œë§Œ ë…¸ì¶œ)
      let rows = (list || []).slice();
      if(txViewMode === "YEAR" && txTypeFilter !== "ALL"){
        rows = rows.filter(x => x.type === txTypeFilter);
      }

      // 2) í‚¤ì›Œë“œ ê²€ìƒ‰
      rows = rows.filter(x => {
        if(!keyword) return true;
        const hay = [x.memberName, x.memo, x.amount, x.category, x.targetMemberName, x.incomeTitle, x.eventTitle].join(" ").toLowerCase();
        return hay.includes(keyword);
      });

      // í‘œì‹œ ê°œìˆ˜ ì•ˆë‚´(â€» í•©ê³„ì¤„ì€ ì¹´ìš´íŠ¸ì— í¬í•¨í•˜ì§€ ì•ŠìŒ)
      if($("txCount")){
        const shown = Math.min(rows.length, txDisplayLimit);
        $("txCount").textContent = rows.length ? `(ì´ ${rows.length}ê±´ ì¤‘ ${shown}ê±´ í‘œì‹œ)` : "";
      }

      if(rows.length === 0){
        $("txList").innerHTML = `<div class="muted">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }

      // 3) ì‹¤ì œ ê±°ë˜ í‘œì‹œ ê°œìˆ˜ëŠ” txDisplayLimit ê¸°ì¤€
      const shownTx = rows.slice(0, txDisplayLimit);

      // 4) ì—°ë„ë³„ + ì›”ë³„ í•©ê³„ í‘œì‹œ: ë³´ì—¬ì¤„ ê±°ë˜(shownTx) ë²”ìœ„ì—ì„œ ì›”ë³„ ì†Œê³„ ì¤„ì„ ì‚½ì…
      let renderRows = shownTx;
      if(txViewMode === "YEAR" && txShowMonthSum){
        const groups = new Map();
        const order = [];

        const monthKey = (tx) => {
          const d = tx?.date?.toDate ? tx.date.toDate() : new Date(tx.date);
          const y = d.getFullYear();
          const m = String(d.getMonth()+1).padStart(2,"0");
          return `${y}-${m}`;
        };

        for(const tx of shownTx){
          const mk = monthKey(tx);
          if(!groups.has(mk)){
            groups.set(mk, []);
            order.push(mk);
          }
          groups.get(mk).push(tx);
        }

        const expanded = [];
        for(const mk of order){
          const g = groups.get(mk) || [];
          let inSum = 0, outSum = 0;
          for(const t of g){
            const amt = Number(t.amount || 0);
            if(t.type === "IN") inSum += amt;
            else if(t.type === "OUT") outSum += amt;
          }
          const net = inSum - outSum;
          expanded.push({ _kind:"MONTH_SUM", month: mk, inSum, outSum, net, count: g.length });
          expanded.push(...g);
        }
        renderRows = expanded;
      }

      // 5) ë Œë”
      $("txList").innerHTML = renderRows.map(x => {
        if(x && x._kind === "MONTH_SUM"){
          const netCls = x.net >= 0 ? "ok" : "bad";
          const netSign = x.net >= 0 ? "+" : "-";
          return `
            <div class="txSum">
              <div class="sumLine">
                <div class="sumLeft">
                  <span class="pill mono">${escapeHtml(x.month)}</span>
                  <span class="muted tiny">${x.count}ê±´</span>
                </div>
                <div class="sumRight">
                  <span class="muted tiny">ì…ê¸ˆ <span class="mono ok sumNum">+${fmtWon(x.inSum)}</span></span>
                  <span class="muted tiny">ì§€ì¶œ <span class="mono bad sumNum">-${fmtWon(x.outSum)}</span></span>
                  <span class="muted tiny">ìˆœì¦ê° <span class="mono ${netCls} sumNum">${netSign}${fmtWon(Math.abs(x.net))}</span></span>
                </div>
              </div>
            </div>
          `;
        }

        const isIn = x.type === "IN";
        const type = isIn ? "ì…ê¸ˆ" : "ì§€ì¶œ";
        const typeCls = isIn ? "ok" : "bad";
        const sign = isIn ? "+" : "-";
        const amtHtml = `<span class="mono ${typeCls}">${sign}${fmtWon(x.amount)}</span>`;
        const who = x.memberName ? `<span class="pill">${escapeHtml(x.memberName)}</span>` : "";
        const cat = x.category ? `<span class="pill">${escapeHtml(categoryLabel(x.category))}</span>` : "";
        const income = x.incomeTitle ? `<span class="pill">ìˆ˜ì…: ${escapeHtml(x.incomeTitle)}</span>` : "";
        const target = x.targetMemberName ? `<span class="pill">ë‹¹ì‚¬ì: ${escapeHtml(x.targetMemberName)}</span>` : "";
        const ev = x.eventTitle ? `<span class="pill">ì´ë²¤íŠ¸: ${escapeHtml(x.eventTitle)}</span>` : "";
        const applied = (x.eventAppliedAmount || x.creditAddedAmount)
          ? `<span class="pill">ì ìš©: ${fmtWon(x.eventAppliedAmount||0)} / ì”ì—¬: ${fmtWon(x.creditAddedAmount||0)}</span>`
          : "";
        const receiptBtn = (x.type === "OUT")
          ? `<span class="muted tiny">ì¦ë¹™: ë„¤ì´ë²„ ë°´ë“œ ì°¸ê³ </span>`
          : ``;

        const memoTxt = String(x.memo || "").trim();
        const memoBtn = memoTxt
          ? `<button class="linkBtn tiny" data-action="toggleMemo" data-id="${x.id}">ìì„¸íˆ ë³´ê¸°</button>`
          : ``;

        return `
          <div class="tx ${isIn ? "" : "outTint"}" data-txid="${x.id}">
            <div class="txTop">
              <div><b class="${typeCls}">${type}</b> ${amtHtml} ${who} ${cat} ${income} ${ev} ${target} ${applied}</div>
              <div class="muted">${fmtDate(x.date)}</div>
            </div>
            <div id="memo-${x.id}" class="muted memo ${memoTxt ? "memoClamp" : ""}" style="margin-top:6px;">${escapeHtml(x.memo || "")}</div>
            <div class="row" style="margin-top:8px; justify-content:flex-end; gap:8px;">${memoBtn}${receiptBtn || ""}</div>
          </div>
        `;
      }).join("") + (rows.length > txDisplayLimit ? `
        <div class="row" style="justify-content:center; padding:10px 0;">
          <button class="secondary" data-action="moreTx">ë” ë³´ê¸°(+30)</button>
        </div>
      ` : "");
    }

    /*********************
     * 8) íšŒì› í˜„í™©(ì›”ë³„)
     *********************/
    async function loadMemberStatus({ memberId, startYm, endYm }){
      // âœ… ì¸ë±ìŠ¤ ì—†ì´ ë™ì‘í•˜ë„ë¡ orderBy ì œê±° í›„ JSì—ì„œ ì •ë ¬
      const qy = query(
        collection(db, colName("memberPeriods")),
        where("memberId","==",memberId)
      );
      const snap = await getDocs(qy);
      const all = snap.docs.map(d => d.data()).sort((a,b)=> ymToNum(a.periodId) - ymToNum(b.periodId));

      const s = ymToNum(startYm);
      const e = ymToNum(endYm);
      const rows = all.filter(x => s <= ymToNum(x.periodId) && ymToNum(x.periodId) <= e);

      const creditSnap = await getDoc(doc(db, colName("credits"), memberId));
      const credit = creditSnap.exists() ? Number(creditSnap.data().balance || 0) : 0;

      return { rows, credit };
    }

    function renderStatus({ rows, credit, startYm, endYm }){
      $("creditLabel").textContent = fmtWon(credit);

      let arrears = 0;
      $("statusGrid").innerHTML = rows.map(x => {
        const due = Number(x.due||0);
        const paid = Number(x.paid||0);

        let tag = "";
        if(x.status === "EXEMPT") tag = `<div class="v muted">ë©´ì œ</div>`;
        else if(paid >= due) tag = `<div class="v ok">ì™„ë‚©</div>`;
        else if(paid > 0){
          arrears += (due - paid);
          tag = `<div class="v warn">ë¶€ë¶„ë‚©</div>`;
        } else {
          arrears += due;
          tag = `<div class="v warn">ë¯¸ë‚©</div>`;
        }

        const detail = x.status === "EXEMPT"
          ? `<div class="muted tiny">${escapeHtml(x.exemptReason || "")}</div>`
          : `<div class="muted tiny">${fmtWon(paid)} / ${fmtWon(due)}</div>`;

        return `
          <div class="monthBox">
            <div class="k mono">${escapeHtml(x.periodId)}</div>
            ${tag}
            ${detail}
          </div>
        `;
      }).join("") || `<div class="muted">ì„ íƒ ë²”ìœ„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (ì´ë¬´: ì„¤ì • íƒ­ì—ì„œ ì›” ìƒì„±)</div>`;

      $("arrearsLabel").textContent = fmtWon(arrears);
    }

    /*********************
     * 9) íƒ­/ìƒíƒœ ê´€ë¦¬
     *********************/
    let state = {
      user: null,
      admin: false,
      members: [],
      events: [],
      tx: [],
      txYear: [],
      yearStatsCurrent: { inSum:0, outSum:0 }
    };

    let currentTab = "dashboard";
    function setTab(name){
      currentTab = name;
      document.querySelectorAll(".tab").forEach(b => b.classList.toggle("active", b.dataset.tab === name));
      ["dashboard","members","settings","admin"].forEach(t => {
        $("tab-"+t).classList.toggle("hidden", t !== name);
      });

      // âœ… ìë™ ìƒˆë¡œê³ ì¹¨ì€ ë”: í•„ìš”í•œ ê²½ìš° 'ìƒˆë¡œê³ ì¹¨' ë²„íŠ¼ìœ¼ë¡œë§Œ ê°±ì‹ 
      // (ë¡œê·¸ì¸ ì§í›„ refreshAll()ë¡œ 1íšŒ ë¡œë”©ì€ ìˆ˜í–‰)
    }

    document.querySelectorAll(".tab").forEach(b => {
      b.addEventListener("click", () => {
        const target = b.dataset.tab;
        setTab(target);
      });
    });

    /*********************
     * 9.2) ëŒ€ì‹œë³´ë“œ ìë™ ìƒˆë¡œê³ ì¹¨(íšŒì›ì´ í•­ìƒ ìµœì‹  í™”ë©´)
     *********************/
    let lastDashboardRefreshAt = 0;
    let lastConfigRefreshAt = 0;
    let dashboardRefreshing = false;

    async function refreshConfigMaybe(force=false){
      const now = Date.now();
      if(force || !cachedConfig || (now - lastConfigRefreshAt) > 60000){
        await refreshConfig();
        lastConfigRefreshAt = Date.now();
      }
    }

    async function refreshDashboardAuto({ force=false, toastMsg=null } = {}){
      if(!state.user) return;
      const now = Date.now();
      if(!force && (now - lastDashboardRefreshAt) < 2500) return; // íƒ­ ì—°íƒ€/ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
      if(dashboardRefreshing) return;

      dashboardRefreshing = true;
      try{
        // configëŠ” ë§¤ë²ˆ ì½ì§€ ë§ê³ (ë¹„ìš©/ì†ë„), 60ì´ˆì— í•œ ë²ˆ ì •ë„ë§Œ ê°±ì‹ 
        await refreshConfigMaybe(false);
        await ensureOpeningForCurrentYear();

        const year = new Date().getFullYear();
        const [recent, ys] = await Promise.all([
           loadTransactions(),
           ensureYearStatsBuilt(year)
        ]);
        state.tx = recent;
        state.yearStatsCurrent = ys;

// âœ… txYearëŠ” â€œì—°ë„ë³„ ë³´ê¸°(YEAR)â€ì—ì„œë§Œ í•„ìš”í•˜ë‹ˆ ì—¬ê¸°ì„œëŠ” êµ³ì´ ì•ˆ ì½ìŒ

      await applyTxView({ force:false });
        renderBalance();

        lastDashboardRefreshAt = Date.now();
        if(toastMsg) toast(toastMsg);
      } finally {
        dashboardRefreshing = false;
      }
    }
    // âœ… ìë™ ìƒˆë¡œê³ ì¹¨(setInterval) ë¹„í™œì„±í™”: ì½ê¸° ì¿¼í„° í­íƒ„ ë°©ì§€

    function lockUI(loggedIn){
      $("lockedCard").classList.toggle("hidden", loggedIn);
      $("appCard").classList.toggle("hidden", !loggedIn);
      $("loginRow").classList.toggle("hidden", loggedIn);
      $("logoutRow").classList.toggle("hidden", !loggedIn);
    }

    function applyRoleBadge(){
      if(!state.user){
        $("roleBadge").classList.add("hidden");
        $("roleBadge").textContent = "";
        return;
      }
      $("roleBadge").classList.remove("hidden");
      $("roleBadge").textContent = state.admin
        ? (PRACTICE_MODE ? "ì´ë¬´(ì—°ìŠµ ëª¨ë“œ)" : "ì´ë¬´(ì“°ê¸° ê°€ëŠ¥)")
        : "íšŒì›(ì½ê¸° ì „ìš©)";

      // ì´ë¬´ íƒ­ì€ ì´ë¬´ë§Œ ì˜ë¯¸ê°€ ìˆìœ¼ë‹ˆ, ë¹„ì´ë¬´ëŠ” ì§„ì…ì€ ê°€ëŠ¥í•˜ì§€ë§Œ ì…ë ¥ì€ ë§‰ëŠ”ë‹¤.
      // (íƒ­ ìì²´ ìˆ¨ê¸°ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ)
      // document.querySelector('[data-tab="admin"]').classList.toggle('hidden', !state.admin);
    }

    function syncAdminLocks(){
      // ì´ë¬´ë§Œ ê°€ëŠ¥í•œ ë²„íŠ¼/ì…ë ¥ ë¹„í™œì„±í™”
      const adminOnlyIds = [
        "btnAddDeposit","btnAddExpense","btnUpsertMember","btnAddExemption","btnAddFee","btnSaveConfig",
        "btnGenForAll","btnGenForOne","btnRecalcRange",
        "btnSaveOpeningBalance","btnResetMoney",
        "btnCreateEvent",
        "btnAddOtherIncome"
      ];
      adminOnlyIds.forEach(id => {
        const el = $(id);
        if(el) el.disabled = !state.admin;
      });
    }

/*********************
 * 9.5) ì§€ì¶œ UI(ê²½ì¡°ì‚¬ ë‹¹ì‚¬ì ì„ íƒ)
 *********************/
function syncOutTargetUI(){
  const cat = $("outCategory")?.value;
  const show = cat === "CONDOLENCE";
  if(!$("outTargetMember")) return;

  $("outTargetMember").classList.toggle("hidden", !show);
  const hint = $("outTargetHint");
  if(hint) hint.style.display = show ? "block" : "none";
}

if($("outCategory")) $("outCategory").addEventListener("change", syncOutTargetUI);

/*********************
 * 9.6) ì…ê¸ˆ UI(ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ / ê°¹ì¶œ)
 *********************/
function syncInEventUI(){
  const mode = $("inMode")?.value;
  const show = mode === "EVENT";
  if($("inEvent")) $("inEvent").classList.toggle("hidden", !show);
}
if($("inMode")) $("inMode").addEventListener("change", syncInEventUI);

    /*********************
     * 9.3) ë„ì›€ë§(ì›” ìƒì„±)
     *********************/
    const monthGenHelpHtml = `
  <div class="muted tiny">ì»´í“¨í„°ë¥¼ ì˜ ëª°ë¼ë„ ì´ ì„¤ëª…ë§Œ ë³´ë©´ ë©ë‹ˆë‹¤. (ë‹¤ìŒ ì´ë¬´ì—ê²Œ ê·¸ëŒ€ë¡œ ë³´ì—¬ì¤˜ë„ OK)</div>

  <div class="helpWarn" style="margin-top:12px;">
    <b>3ì¤„ ìš”ì•½</b>
    <ul class="helpList" style="margin-top:8px;">
      <li><b>ì›” ìƒì„±</b> = íšŒì›ë³„ë¡œ â€˜ì›”ë³„ ì²­êµ¬ì„œ(YYYY-MM)â€™ë¥¼ ë¯¸ë¦¬ ë§Œë“¤ì–´ ë‘ëŠ” ì‘ì—…</li>
      <li><b>(ì£¼ì˜) ë²”ìœ„ ì¬ê³„ì‚°</b> = ê·¸ ì²­êµ¬ì„œì˜ <b>ì²­êµ¬ê¸ˆì•¡(due)Â·ë©´ì œ</b>ë§Œ ìµœì‹  ê·œì¹™ìœ¼ë¡œ ë‹¤ì‹œ ê³„ì‚° (ì´ë¯¸ ë‚¸ ëˆ(paid)ì€ ê·¸ëŒ€ë¡œ)</li>
      <li>ê¶Œì¥ ìˆœì„œ: <b>íšŒë¹„ ì„¤ì • ì €ì¥ â†’ ì›” ìƒì„±(í•„ìš”í•˜ë©´) â†’ ì¬ê³„ì‚°</b></li>
    </ul>
  </div>

  <div class="helpH"><b>1) â€˜ì›”ë³„ ì²­êµ¬ì„œâ€™ê°€ ë­ì˜ˆìš”?</b></div>
  <ul class="helpList">
    <li>íšŒì›ë§ˆë‹¤ ë§¤ë‹¬ â€œì´ë²ˆ ë‹¬ íšŒë¹„ëŠ” ì–¼ë§ˆâ€ë¼ê³  ì í˜€ ìˆëŠ” <b>ì²­êµ¬ì„œ í•œ ì¥</b>ì´ ìˆë‹¤ê³  ìƒê°í•˜ë©´ ë©ë‹ˆë‹¤.</li>
    <li>ì´ ì•±ì—ì„œëŠ” ê·¸ ì²­êµ¬ì„œê°€ <span class="mono">memberPeriods</span>ì— ì €ì¥ë©ë‹ˆë‹¤. (ì˜ˆ: 2025-09)</li>
    <li>ì²­êµ¬ì„œì—ëŠ” 3ê°€ì§€ë§Œ ì¤‘ìš”í•©ë‹ˆë‹¤: <b>ì²­êµ¬ì•¡(due)</b>, <b>ë‚©ë¶€ì•¡(paid)</b>, <b>ìƒíƒœ(ë¯¸ë‚©/ë¶€ë¶„/ì™„ë‚©/ë©´ì œ)</b></li>
  </ul>

  <div class="helpH"><b>2) ì›” ìƒì„±ì€ ì–¸ì œ ëˆŒëŸ¬ìš”?</b></div>
  <ul class="helpList">
    <li><b>ì²˜ìŒ ì„¸íŒ…</b>: ê¸°ê°„ì„ ë„‰ë„‰íˆ ì¡ì•„ <b>ì „ì²´ íšŒì› ìƒì„±</b> í•œ ë²ˆ (ì˜ˆ: 2024-01 ~ 2026-12)</li>
    <li><b>ìƒˆ íšŒì› ì¶”ê°€</b>: ê·¸ íšŒì›ë§Œ <b>ì„ íƒ íšŒì› ìƒì„±</b></li>
    <li>ì›” ìƒì„±ì€ <b>ê±°ë˜ë‚´ì—­(ì…ê¸ˆ/ì§€ì¶œ)ì„ ë§Œë“¤ì§€ ì•ŠìŠµë‹ˆë‹¤.</b> ê·¸ëƒ¥ â€œì²­êµ¬ì„œ ì¢…ì´â€ë§Œ ë§Œë“¤ì–´ ë‘¡ë‹ˆë‹¤.</li>
  </ul>

  <div class="helpH"><b>3) (ì£¼ì˜) ë²”ìœ„ ì¬ê³„ì‚°ì€ ì–¸ì œ ëˆŒëŸ¬ìš”?</b></div>
  <ul class="helpList">
    <li><b>íšŒì›ì´ ìƒˆë¡œ ë“¤ì–´ì™”ê±°ë‚˜</b> (ì˜ì…)</li>
    <li><b>íšŒë¹„ ê¸ˆì•¡ì´ ë°”ë€Œì—ˆê±°ë‚˜</b> (ì˜ˆ: 2026-02ë¶€í„° ì¸ìƒ)</li>
    <li><b>ë©´ì œ ê¸°ê°„ì„ ì¶”ê°€/ìˆ˜ì •í–ˆê±°ë‚˜</b></li>
  </ul>

  <div class="helpH"><b>4) ì¬ê³„ì‚°ì„ ëˆ„ë¥´ë©´ ë­ê°€ ë°”ë€Œê³ , ë­ê°€ ì•ˆ ë°”ë€Œë‚˜ìš”?</b></div>
  <ul class="helpList">
    <li>âœ… ë°”ë€ŒëŠ” ê²ƒ: <b>ì²­êµ¬ì•¡(due)</b>, <b>ë©´ì œ ì—¬ë¶€</b>, <b>ìƒíƒœ(ë¯¸ë‚©/ë¶€ë¶„/ì™„ë‚©/ë©´ì œ)</b></li>
    <li>âŒ ì•ˆ ë°”ë€ŒëŠ” ê²ƒ(í•µì‹¬): <b>ë‚©ë¶€ì•¡(paid)</b> = ì´ë¯¸ ë‚¸ ëˆì€ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤.</li>
    <li>ì¦‰, <b>ì¥ë¶€ë¥¼ ì§€ìš°ëŠ” ê¸°ëŠ¥ì´ ì•„ë‹ˆë¼</b> â€œì²­êµ¬ì„œ ë‚´ìš©ì„ ìµœì‹  ê·œì¹™ìœ¼ë¡œ ì—…ë°ì´íŠ¸â€í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.</li>
  </ul>

  <div class="helpWarn" style="margin-top:12px;">
    <b>ì‹¤ìˆ˜ ë°©ì§€ ì²´í¬</b>
    <ul class="helpList" style="margin-top:8px;">
      <li>íšŒë¹„ ê¸ˆì•¡ì„ ë°”ê¿¨ë‹¤ë©´: <b>íšŒë¹„ ì„¤ì •ì—ì„œ ì €ì¥ ë²„íŠ¼ì„ ë¨¼ì € ëˆ„ë¥´ê¸°</b></li>
      <li>ë²”ìœ„ëŠ” â€œë°”ë€ ë‹¬â€ì´ í¬í•¨ë˜ê²Œ ì¡ê¸° (ì˜ˆ: 2026-02ë¶€í„° ë³€ê²½ì´ë©´ 2026-02 ~ 2026-12)</li>
      <li>ì´ í™”ë©´ì˜ ì¬ê³„ì‚°ì€ <b>ì„ íƒí•œ íšŒì› 1ëª…</b> ê¸°ì¤€ì…ë‹ˆë‹¤. (íšŒì› ì„ íƒ í•„ìˆ˜)</li>
    </ul>
  </div>

  <div class="helpH"><b>5) ê°€ì¥ í”í•œ ì˜ˆì‹œ</b></div>
  <ul class="helpList">
    <li><b>íšŒë¹„ ì¸ìƒ</b>: 2026-02ë¶€í„° 20,000 â†’ 25,000
      <div class="muted tiny" style="margin-top:6px;">â‘  íšŒë¹„ ì„¤ì •ì—ì„œ 2026-02 / 25000 ì¶”ê°€ â†’ â‘¡ <b>ì €ì¥</b> â†’ â‘¢ (í•„ìš”í•œ íšŒì›) ë²”ìœ„ ì¬ê³„ì‚°</div>
    </li>
    <li><b>ë©´ì œ ì¶”ê°€</b>: ì–´ë–¤ íšŒì› 2025ë…„ 1~12ì›” ë©´ì œ
      <div class="muted tiny" style="margin-top:6px;">â‘  ë©´ì œ ì¶”ê°€ â†’ â‘¡ ê·¸ íšŒì› ì„ íƒ â†’ â‘¢ 2025-01 ~ 2025-12 ë²”ìœ„ ì¬ê³„ì‚°</div>
    </li>
  </ul>

  <div class="helpWarn" style="margin-top:12px;">
    <b>ì£¼ì˜!</b> ì›” ìƒì„± ì „ì— ì…ê¸ˆ(ì›”íšŒë¹„ ìë™ë°°ì •)ì„ ë¨¼ì € ë“±ë¡í•˜ë©´,
    ë°°ì •í•  â€œë¯¸ë‚© ì›” ì²­êµ¬ì„œâ€ê°€ ì—†ì–´ì„œ <b>ì„ ìˆ˜ê¸ˆ(í¬ë ˆë”§)</b>ìœ¼ë¡œë§Œ ë‚¨ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    <div class="muted tiny" style="margin-top:6px;">ê¶Œì¥ ìˆœì„œ: <b>ì›” ìƒì„± â†’ ì…ê¸ˆ ë“±ë¡</b></div>
  </div>
`;

    function openHelp(html){
      $("helpBody").innerHTML = html;
      $("helpOverlay").classList.remove("hidden");
      $("btnHelpClose").focus();
    }

    function closeHelp(){
      $("helpOverlay").classList.add("hidden");
    }

    $("btnMonthGenHelp")?.addEventListener("click", () => openHelp(monthGenHelpHtml));
    $("btnHelpClose")?.addEventListener("click", closeHelp);
    $("helpOverlay")?.addEventListener("click", (e) => { if(e.target === $("helpOverlay")) closeHelp(); });
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && !$("helpOverlay").classList.contains("hidden")) closeHelp();
    });


    
    /*********************
     * 10) ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
     *********************/
    $("btnLogin").addEventListener("click", async () => {
      const email = $("email").value.trim();
      const pw = $("password").value;
      if(!email || !pw) return alert("ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      try{
        await signInWithEmailAndPassword(auth, email, pw);
      } catch(e){
        // âœ… ì¤„ë°”ê¿ˆì€ ì‹¤ì œ ì¤„ë°”ê¿ˆì´ ì•„ë‹ˆë¼ "\n"(ë°±ìŠ¬ë˜ì‹œ+n)ë¡œ ì¨ì•¼ ë¬¸ë²• ì˜¤ë¥˜ê°€ ì•ˆ ë‚©ë‹ˆë‹¤.
        alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + (e?.code || "") + "\n" + (e?.message || "ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."));
        console.error(e);
      }
    });

    $("btnLogout").addEventListener("click", async () => {
      await signOut(auth);
    });

    // ğŸ”° ì—°ìŠµ ëª¨ë“œ í† ê¸€(ì´ë¬´ ì „ìš©)
    $("practiceToggle")?.addEventListener("change", async () => {
      const tgl = $("practiceToggle");
      if(!tgl) return;
      if(!state.admin){
        tgl.checked = false;
        return alert("ì´ë¬´ë§Œ ì—°ìŠµ ëª¨ë“œë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      }

      const wantOn = !!tgl.checked;
      if(wantOn){
        const ok = confirm(`ì—°ìŠµ ëª¨ë“œë¥¼ ì¼œë©´ \"demo_\" ë°ì´í„° ê³µê°„ìœ¼ë¡œ ì „í™˜ë©ë‹ˆë‹¤.
ì‹¤ì œ ì¥ë¶€ ë°ì´í„°ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì—°ìŠµ ëª¨ë“œë¥¼ ì¼¤ê¹Œìš”?`);
        if(!ok){
          tgl.checked = false;
          return;
        }
      }

      PRACTICE_MODE = wantOn;

      // âœ… ìºì‹œ ì´ˆê¸°í™”: ì‹¤ì œ/ì—°ìŠµ ë°ì´í„° ì„ì„ ë°©ì§€
      try{
        txYearCache.clear();
        eventMembersCache.clear();
        yearStatsCache.clear();
      } catch(_){}

      if(PRACTICE_MODE) localStorage.setItem("practice_mode", "1");
      else localStorage.removeItem("practice_mode");

      applyRoleBadge();
      syncPracticeUI();
      toast(PRACTICE_MODE ? "ì—°ìŠµ ëª¨ë“œ ON (Demo)" : "ì—°ìŠµ ëª¨ë“œ OFF (ì‹¤ì œ)");

      // ë°ì´í„° ì†ŒìŠ¤ê°€ ë°”ë€Œë¯€ë¡œ ì „ì²´ ë¦¬ë¡œë“œ
      try{
        await refreshAll();
        setTab("dashboard");
      } catch(e){
        alert(e?.message || String(e));
        console.error(e);
      }
    });

    $("btnRefresh").addEventListener("click", async () => {
      txDisplayLimit = 30;
      await refreshDashboardAuto({ force:true, toastMsg:"ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ" });

      // YEAR ëª¨ë“œë¼ë©´ ì„ íƒ ì—°ë„ë„ ê°•ì œë¡œ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
      if(txViewMode === "YEAR"){
        await loadTxYearView(txViewYear, { force:true });
      }
      await applyTxView({ force:false });
    });

    // ê±°ë˜ë‚´ì—­ ë³´ê¸° ëª¨ë“œ ì „í™˜
    $("txViewMode")?.addEventListener("change", async () => {
      txDisplayLimit = 30;
      txViewMode = $("txViewMode")?.value || "RECENT";
      fillTxYearSelect();
      syncTxViewControls();

      if(txViewMode === "YEAR"){
        txViewYear = Number($("txYearSelect")?.value || new Date().getFullYear());
        toast(`${txViewYear}ë…„ ê±°ë˜ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`);
        await loadTxYearView(txViewYear, { force:false });
      }
      await applyTxView({ force:false });
    });

    $("txYearSelect")?.addEventListener("change", async () => {
      if(txViewMode !== "YEAR") return;
      txDisplayLimit = 30;
      txViewYear = Number($("txYearSelect")?.value || new Date().getFullYear());
      syncTxViewControls();
      toast(`${txViewYear}ë…„ ê±°ë˜ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`);
      await loadTxYearView(txViewYear, { force:false });
      await applyTxView({ force:false });
    });

    // ì—°ë„ë³„: ì…ê¸ˆ/ì§€ì¶œë§Œ ë³´ê¸°
    $("txTypeFilter")?.addEventListener("change", async () => {
      if(txViewMode !== "YEAR") return;
      txDisplayLimit = 30;
      txTypeFilter = $("txTypeFilter")?.value || "ALL";
      await applyTxView({ force:false });
    });

    // ì—°ë„ë³„: ì›”ë³„ í•©ê³„ ì¤„ í‘œì‹œ
    $("txMonthSum")?.addEventListener("change", () => {
      if(txViewMode !== "YEAR") return;
      txDisplayLimit = 30;
      txShowMonthSum = !!$("txMonthSum")?.checked;
      renderTxList(getTxViewList());
    });

    $("txFilter").addEventListener("input", () => {
      txDisplayLimit = 30;
      renderTxList(getTxViewList());
    });

    // ê±°ë˜ë‚´ì—­ ë©”ëª¨: 2ì¤„ ë¯¸ë¦¬ë³´ê¸° + (ìì„¸íˆ ë³´ê¸°/ì ‘ê¸°)
    // ê±°ë˜ë‚´ì—­ ë©”ëª¨: 2ì¤„ ë¯¸ë¦¬ë³´ê¸° + (ìì„¸íˆ ë³´ê¸°/ì ‘ê¸°)
    $("txList").addEventListener("click", (e) => {
      // ë” ë³´ê¸°
      const more = e.target.closest('button[data-action="moreTx"]');
      if(more){
        txDisplayLimit += 30;
        renderTxList(getTxViewList());
        return;
      }

      const btn = e.target.closest('button[data-action="toggleMemo"]');
      if(!btn) return;
      const id = btn.dataset.id;
      const memoEl = document.getElementById(`memo-${id}`);
      if(!memoEl) return;

      memoEl.classList.toggle("memoClamp");
      const clamped = memoEl.classList.contains("memoClamp");
      btn.textContent = clamped ? "ìì„¸íˆ ë³´ê¸°" : "ì ‘ê¸°";
    });

    /*********************
     * ê±°ë˜ë‚´ì—­: ë¡±í”„ë ˆìŠ¤(ê¸¸ê²Œ ëˆ„ë¥´ê¸°)ë¡œ ì‚­ì œ íŒì—…
     *********************/
    let txLongPressTimer = null;
    let txLongPressTargetId = null;
    let txLongPressStart = null;

    function openTxActionOverlay(txId){
      const tx = getTxViewList().find(t => t.id === txId)
        || (state.tx || []).find(t => t.id === txId)
        || (state.txYear || []).find(t => t.id === txId)
        || (() => {
          for(const list of txYearCache.values()){
            const f = (list || []).find(t => t.id === txId);
            if(f) return f;
          }
          return null;
        })();
      if(!tx) return alert("ê±°ë˜ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
      txLongPressTargetId = txId;

      const isIn = tx.type === "IN";
      const type = isIn ? "ì…ê¸ˆ" : "ì§€ì¶œ";
      const sign = isIn ? "+" : "-";

      $("txActionBody").innerHTML = `
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div><b>${escapeHtml(type)}</b> <span class="mono">${sign}${fmtWon(tx.amount)}</span></div>
            <div class="muted tiny" style="margin-top:6px;">
              ${tx.memberName ? `ì…ê¸ˆì: <b>${escapeHtml(tx.memberName)}</b> Â· ` : ""}
              ${tx.category ? `êµ¬ë¶„: <b>${escapeHtml(categoryLabel(tx.category))}</b> Â· ` : ""}
              ${tx.incomeTitle ? `ìˆ˜ì…ë‚´ìš©: <b>${escapeHtml(tx.incomeTitle)}</b> Â· ` : ""}
              ${tx.eventTitle ? `ì´ë²¤íŠ¸: <b>${escapeHtml(tx.eventTitle)}</b> Â· ` : ""}
              ${tx.targetMemberName ? `ë‹¹ì‚¬ì: <b>${escapeHtml(tx.targetMemberName)}</b>` : ""}
            </div>
          </div>
          <div class="muted">${fmtDate(tx.date)}</div>
        </div>
        <div class="hr"></div>
        <div class="muted tiny">ë©”ëª¨</div>
        <div class="memo" style="margin-top:6px;">${escapeHtml(tx.memo || "(ì—†ìŒ)")}</div>
      `;

      $("txActionOverlay").classList.remove("hidden");
      $("btnTxClose").focus();
    }

    function closeTxActionOverlay(){
      txLongPressTargetId = null;
      $("txActionOverlay").classList.add("hidden");
    }

    $("btnTxClose")?.addEventListener("click", closeTxActionOverlay);
    $("txActionOverlay")?.addEventListener("click", (e) => { if(e.target === $("txActionOverlay")) closeTxActionOverlay(); });
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && !$("txActionOverlay").classList.contains("hidden")) closeTxActionOverlay();
    });

    function getPointerXY(e){
      if(e.touches && e.touches[0]) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
      if(e.changedTouches && e.changedTouches[0]) return { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
      return { x: e.clientX, y: e.clientY };
    }

    function clearTxLongPress(){
      if(txLongPressTimer){ clearTimeout(txLongPressTimer); txLongPressTimer = null; }
      txLongPressStart = null;
    }

    // ëª¨ë°”ì¼/ë°ìŠ¤í¬í†± ê³µí†µ: pointer ì´ë²¤íŠ¸ë¡œ ë¡±í”„ë ˆìŠ¤ ê°ì§€
    $("txList").addEventListener("pointerdown", (e) => {
      if(!state.admin) return;
      if(e.button !== undefined && e.button !== 0) return; // ì¢Œí´ë¦­ë§Œ
      if(e.target.closest("button") || e.target.closest("input") || e.target.closest("select") || e.target.closest("textarea")) return;

      const row = e.target.closest(".tx[data-txid]");
      if(!row) return;
      const txId = row.dataset.txid;
      if(!txId) return;

      const p = getPointerXY(e);
      txLongPressStart = { x:p.x, y:p.y };

      clearTxLongPress();
      txLongPressTimer = setTimeout(() => {
        openTxActionOverlay(txId);
      }, 550);
    }, { passive:true });

    $("txList").addEventListener("pointermove", (e) => {
      if(!txLongPressTimer || !txLongPressStart) return;
      const p = getPointerXY(e);
      const dx = Math.abs(p.x - txLongPressStart.x);
      const dy = Math.abs(p.y - txLongPressStart.y);
      if(dx > 12 || dy > 12) clearTxLongPress();
    }, { passive:true });

    $("txList").addEventListener("pointerup", clearTxLongPress, { passive:true });
    $("txList").addEventListener("pointercancel", clearTxLongPress, { passive:true });

    $("btnQuickRange").addEventListener("click", () => {
      const now = new Date();
      const end = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
      let d = new Date(now.getFullYear(), now.getMonth(), 1);
      d.setMonth(d.getMonth()-11);
      const start = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
      $("rangeStart").value = start;
      $("rangeEnd").value = end;
    });

    $("btnLoadStatus").addEventListener("click", async () => {
      const memberId = $("memberSelect").value;
      const startYm = $("rangeStart").value.trim();
      const endYm = $("rangeEnd").value.trim();
      if(!memberId) return alert("íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”.");
      if(!isYm(startYm) || !isYm(endYm)) return alert("ë²”ìœ„ëŠ” YYYY-MM í˜•ì‹ì…ë‹ˆë‹¤.");

      const res = await loadMemberStatus({ memberId, startYm, endYm });
      renderStatus({ ...res, startYm, endYm });
    });

    $("btnReloadMembers").addEventListener("click", async () => {
      await refreshMembers();
      toast("íšŒì› ëª©ë¡ ìƒˆë¡œê³ ì¹¨");
    });

    // íšŒì› ëª©ë¡ì—ì„œ: íšŒì› ìˆ˜ì •/ì œëª…, ë©´ì œ ìˆ˜ì •/ì‚­ì œ
    $("memberList").addEventListener("click", async (e) => {
      const btn = e.target.closest('button[data-action]');
      if(!btn) return;
      if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");

      const action = btn.dataset.action;
      const memberId = btn.dataset.member;
      const idx = btn.dataset.idx !== undefined ? Number(btn.dataset.idx) : null;
      const member = (state.members || []).find(m => m.name === memberId);
      if(!member) return alert("íšŒì›ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

      // 1) íšŒì› ìˆ˜ì •: í¼ì— ì±„ì›Œ ë„£ê¸°
      if(action === "editMember"){
        $("mName").value = member.name || "";
        $("mActiveFrom").value = member.activeFrom || "";
        $("mActiveTo").value = member.activeTo || "";
        toast("íšŒì› ê´€ë¦¬ í¼ì— ê°’ì„ ì±„ì› ìŠµë‹ˆë‹¤. ì €ì¥ì„ ëˆ„ë¥´ë©´ ë°˜ì˜ë©ë‹ˆë‹¤.");
        return;
      }

      // 2) ì œëª…(í™œë™ ì¢…ë£Œì›” ì„¤ì •)
      if(action === "kickMember"){
        const now = new Date();
        const ym = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}`;
        const input = prompt(`í™œë™ ì¢…ë£Œì›”ì„ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM).
ì˜ˆ: 2025-12

ë¹„ì›Œë‘ë©´ 'í™œë™ì¤‘'ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.`, member.activeTo || ym);
        if(input === null) return; // ì·¨ì†Œ
        const v = input.trim();
        if(v && !isYm(v)) return alert("í˜•ì‹ ì˜¤ë¥˜: YYYY-MM");
        try{
          await setMemberActiveTo({ memberId, activeTo: v || null });
          toast(v ? `ì œëª… ì²˜ë¦¬ ì™„ë£Œ(ì¢…ë£Œì›” ${v})` : "í™œë™ì¤‘ìœ¼ë¡œ ë³µê·€");
          await refreshMembers();
        } catch(err){
          alert(err.message || String(err));
        }
        return;
      }

      // 3) ë©´ì œ ìˆ˜ì •(í¼ì— ì±„ìš°ê³  ìˆ˜ì •ëª¨ë“œ)
      if(action === "editEx"){
        const ex = Array.isArray(member.exemptions) ? member.exemptions : [];
        if(idx === null || idx < 0 || idx >= ex.length) return alert("ë©´ì œ ì¸ë±ìŠ¤ ì˜¤ë¥˜");
        const it = ex[idx];
        $("exMember").value = memberId;
        $("exFrom").value = it.from || "";
        $("exTo").value = it.to || "";
        $("exReason").value = it.reason || "";
        exemptionEdit = { memberId, idx };
        $("btnAddExemption").textContent = "ë©´ì œ ìˆ˜ì • ì €ì¥";
        toast("ë©´ì œ ìˆ˜ì • ëª¨ë“œ: ìˆ˜ì • í›„ 'ë©´ì œ ìˆ˜ì • ì €ì¥'ì„ ëˆ„ë¥´ì„¸ìš”.");
        return;
      }

      // 4) ë©´ì œ ì‚­ì œ
      if(action === "delEx"){
        const ok = confirm(`ë©´ì œë¥¼ ì‚­ì œí• ê¹Œìš”?

íšŒì›: ${memberId}`);
        if(!ok) return;
        try{
          await removeExemptionAt({ memberId, idx });
          toast("ë©´ì œ ì‚­ì œ ì™„ë£Œ");
          await refreshMembers();
        } catch(err){
          alert(err.message || String(err));
        }
        return;
      }
    });

    $("btnUpsertMember").addEventListener("click", async () => {
  if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  const btn = $("btnUpsertMember");
  try{
    if(btn) btn.disabled = true;

    const id = await upsertMember({
      name: $("mName").value,
      activeFrom: $("mActiveFrom").value.trim(),
      activeTo: $("mActiveTo").value.trim()
    });
        toast(`íšŒì› ì €ì¥: ${id}`);
        $("mName").value = "";
        $("mActiveFrom").value = "";
        $("mActiveTo").value = "";
        await refreshMembers();
      } catch(e){
    alert(e.message || String(e));
  } finally {
    // ì„±ê³µ/ì‹¤íŒ¨ì™€ ë¬´ê´€í•˜ê²Œ ë²„íŠ¼ ì ê¸ˆ í•´ì œ
    if(btn) btn.disabled = !state.admin;
  }
});

    // ë©´ì œ ì¶”ê°€/ìˆ˜ì •
    let exemptionEdit = null; // { memberId, idx }

    function resetExemptionForm(){
      exemptionEdit = null;
      $("exFrom").value = "";
      $("exTo").value = "";
      $("exReason").value = "";
      if($("btnAddExemption")) $("btnAddExemption").textContent = "ë©´ì œ ì¶”ê°€";
    }

    $("btnAddExemption").addEventListener("click", async () => {
      if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      try{
        const memberId = $("exMember").value;
        const from = $("exFrom").value.trim();
        const to = $("exTo").value.trim();
        const reason = $("exReason").value.trim();

        if(exemptionEdit && exemptionEdit.memberId === memberId){
          await updateExemptionAt({ memberId, idx: exemptionEdit.idx, from, to, reason });
          toast("ë©´ì œ ìˆ˜ì • ì™„ë£Œ");
        } else {
          await addExemption({ memberId, from, to, reason });
          toast("ë©´ì œ ì¶”ê°€ ì™„ë£Œ");
        }

        resetExemptionForm();
        await refreshMembers();
      } catch(e){
        alert(e.message || String(e));
      }
    });

    // ì§€ì¶œ ë“±ë¡
$("btnAddExpense").addEventListener("click", async () => {
  if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");

  const category = $("outCategory").value;
  const amount = Number($("outAmount").value || 0);
  const dateStr = $("outDate").value;
  const memo = $("outMemo").value.trim();
  const targetMemberId = category === "CONDOLENCE" ? $("outTargetMember").value : "";

  if(!amount || amount <= 0) return alert("ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”.");
  if(!dateStr) return alert("ë‚ ì§œ ì„ íƒ í•„ìš”");
  if(category === "CONDOLENCE" && !targetMemberId) return alert("ê²½ì¡°ì‚¬ ë‹¹ì‚¬ì(ë³¸ì¸)ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

  try{
    const [y,m,d] = dateStr.split("-").map(Number);
    const date = Timestamp.fromDate(new Date(y, m-1, d, 12, 0, 0));

    const txRef = doc(collection(db, colName("transactions")));
    const txYear = yearOf(date);

    await runTransaction(db, async (t) => {
      t.set(txRef, {
        type: "OUT",
        category,
        amount,
        memo,
        date,
        targetMemberId: targetMemberId || null,
        targetMemberName: targetMemberId || null,
        createdByUid: state.user.uid,
        createdAt: Timestamp.now()
      });

      bumpYearStatsInTxn(t, txYear, { outDelta: amount });
    });

    bumpYearStatsLocal(txYear, { outDelta: amount });

    $("outAmount").value = "";
    $("outMemo").value = "";
    toast("ì§€ì¶œ ë“±ë¡ ì™„ë£Œ");
    await refreshAll();
    setTab("dashboard");
  } catch(e){
    alert(e?.message || String(e));
    console.error(e);
  }
});

// âœ… ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ / ê°¹ì¶œ ìƒì„±
$("btnCreateEvent")?.addEventListener("click", async () => {
  if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
  const btn = $("btnCreateEvent");
  try{
    const title = $("evTitle").value.trim();
    const targetMemberId = $("evTargetMember").value;
    const excludedMemberIds = getSelectedEventExcludes().filter(x => x && x !== targetMemberId);
    const perPersonAmount = Number($("evPerAmount").value || 0);
    const dateStr = $("evDate").value;
    const memo = $("evMemo").value.trim();

    if(!targetMemberId) return alert("ê²½ì¡°ì‚¬ ë‹¹ì‚¬ì(ë³¸ì¸)ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    if(!perPersonAmount || perPersonAmount <= 0) return alert("1ì¸ë‹¹ ê°¹ì¶œ ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”.");
    if(!dateStr) return alert("ë‚ ì§œ ì„ íƒ í•„ìš”");

    // âœ… ìƒì„± ì „ í™•ì¸(ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ëŠ” ìˆ˜ì •/ì‚­ì œ ë¶ˆê°€)
    const ym = String(dateStr).slice(0,7);
    const excludeSet = new Set((excludedMemberIds || []).filter(x => x && x !== targetMemberId));
    const participants = (state.members || [])
      .filter(m => inActive(m, ym))
      .map(m => m.name)
      .filter(n => n && n !== targetMemberId && !excludeSet.has(n));
    const totalDuePreview = perPersonAmount * participants.length;

    const excludeText = excludeSet.size ? [...excludeSet].join(", ") : "ì—†ìŒ";
    const confirmMsg =
      `âš ï¸ ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ ìƒì„± í™•ì¸

`+
      `ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ëŠ” ìƒì„± í›„ ìˆ˜ì •/ì‚­ì œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.
`+
      `ë³¸ì¸/ì œì™¸íšŒì›/ê°¹ì¶œê¸ˆì„ ì •í™•íˆ í™•ì¸í•˜ì…¨ìŠµë‹ˆê¹Œ?

`+
      `- ì´ë²¤íŠ¸ëª…: ${title || "ê²½ì¡°ì‚¬"}
`+
      `- ê²½ì¡°ì‚¬ íšŒì› ë³¸ì¸: ${targetMemberId}
`+
      `- ì œì™¸ íšŒì›: ${excludeText}
`+
      `- ê°¹ì¶œ ëŒ€ìƒ: ${participants.length}ëª…
`+
      `- 1ì¸ë‹¹ ê°¹ì¶œ ê¸ˆì•¡: ${fmtWon(perPersonAmount)}
`+
      `- ì„ ì§€ì¶œ ì´ì•¡: ${fmtWon(totalDuePreview)}

`+
      `ìƒì„±í• ê¹Œìš”?`;

    if(!confirm(confirmMsg)) return;

    // ì‹¤ìˆ˜ë¡œ 2ë²ˆ ëˆŒëŸ¬ ì¤‘ë³µ ìƒì„±ë˜ëŠ” ê²ƒ ë°©ì§€
    if(btn) btn.disabled = true;

    const eventId = await createCondolenceEvent({ title, targetMemberId, excludedMemberIds, perPersonAmount, dateStr, memo });
    toast("ì´ë²¤íŠ¸ ìƒì„± ì™„ë£Œ");

    // ì…ë ¥ ì´ˆê¸°í™”
    $("evTitle").value = "";
    $("evMemo").value = "";
    clearEventExcludeChecks();

    await refreshAll();
    // ì…ê¸ˆ íƒ­ì—ì„œ ë°”ë¡œ ì„ íƒí•  ìˆ˜ ìˆë„ë¡
    if($("inMode")) $("inMode").value = "EVENT";
    syncInEventUI();
    if($("inEvent")) $("inEvent").value = eventId;
    setTab("dashboard");
  } catch(e){
    alert(e.message || String(e));
  } finally {
    if(btn) btn.disabled = !state.admin;
  }
});

// âœ… ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
$("btnReloadEvents")?.addEventListener("click", async () => {
  await refreshEvents();
  toast("ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ ìƒˆë¡œê³ ì¹¨");
});

// âœ… ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ ìƒì„¸ í† ê¸€
$("eventList")?.addEventListener("click", async (e) => {
  const btn = e.target.closest('button[data-action="toggleEvent"]');
  if(!btn) return;
  const eventId = btn.dataset.id;
  const host = document.getElementById(`evDetail-${eventId}`);
  if(!host) return;

  const isOpen = !host.classList.contains("hidden");
  if(isOpen){
    host.classList.add("hidden");
    btn.textContent = "ìì„¸íˆ ë³´ê¸°";
    return;
  }

  btn.textContent = "ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
  try{
    let rows = eventMembersCache.get(eventId);
    if(!rows){
      rows = await loadEventMembers(eventId);
      eventMembersCache.set(eventId, rows);
    }

    const paidCnt = rows.filter(r => r.status === "PAID").length;
    const partialCnt = rows.filter(r => r.status === "PARTIAL").length;
    const unpaidCnt = rows.filter(r => r.status === "UNPAID").length;

    host.innerHTML = `
      <div class="muted tiny">ë‚©ë¶€ ${paidCnt}ëª… Â· ë¶€ë¶„ ${partialCnt}ëª… Â· ë¯¸ë‚© ${unpaidCnt}ëª…</div>
      <div class="hr"></div>
      ${rows.map(r => {
        const due = Number(r.due||0);
        const paid = Number(r.paid||0);
        const st = r.status === "PAID" ? `<span class="ok">ì™„ë‚©</span>` : (r.status === "PARTIAL" ? `<span class="warn">ë¶€ë¶„</span>` : `<span class="warn">ë¯¸ë‚©</span>`);
        return `
          <div class="tx">
            <div class="txTop">
              <div><b>${escapeHtml(r.memberId||"")}</b> ${st}</div>
              <div class="muted tiny">${fmtWon(paid)} / ${fmtWon(due)}</div>
            </div>
          </div>
        `;
      }).join("")}
    `;

    host.classList.remove("hidden");
    btn.textContent = "ì ‘ê¸°";
  } catch(err){
    alert(err.message || String(err));
    btn.textContent = "ìì„¸íˆ ë³´ê¸°";
  }
});

// íšŒë¹„ ì„¤ì •
    let cachedConfig = null;

    function renderFeeHistory(){
      const list = cachedConfig?.feeHistory || [];
      if(list.length === 0){
        $("feeHistory").innerHTML = `<div class="muted">ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
        return;
      }
      const sorted = [...list].sort((a,b)=> ymToNum(a.from)-ymToNum(b.from));
      $("feeHistory").innerHTML = sorted.map((x,idx)=>`
        <div class="row" style="justify-content:space-between; border-bottom:1px solid var(--line); padding:8px 0;">
          <div class="mono">${escapeHtml(x.from)}ë¶€í„°</div>
          <div>${fmtWon(x.amount)}</div>
        </div>
      `).join("");
    }

    $("btnAddFee").addEventListener("click", async () => {
      if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      const from = $("feeFrom").value.trim();
      const amount = Number($("feeAmount").value || 0);
      if(!isYm(from)) return alert("ì ìš© ì‹œì‘ì›”ì€ YYYY-MM");
      if(!amount || amount <= 0) return alert("ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”.");

      cachedConfig.feeHistory = Array.isArray(cachedConfig.feeHistory) ? cachedConfig.feeHistory : [];
      cachedConfig.feeHistory.push({ from, amount });
      // ì¤‘ë³µ fromì´ ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ, ê°™ì€ fromì´ë©´ ë§ˆì§€ë§‰ ê°’ì„ ì‚¬ìš©í•˜ë„ë¡ ì •ë¦¬
      const map = new Map();
      for(const it of cachedConfig.feeHistory){
        if(isYm(it.from)) map.set(it.from, Number(it.amount||0));
      }
      cachedConfig.feeHistory = [...map.entries()].map(([f,a])=>({from:f, amount:a}));

      renderFeeHistory();
      $("feeFrom").value = "";
      $("feeAmount").value = "";
      toast("ì¶”ê°€ë¨(ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ í™•ì •)");
    });

    $("btnSaveConfig").addEventListener("click", async () => {
      if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      const ref = doc(db, "config", configDocId());
      await setDoc(ref, cachedConfig, { merge:true });
      toast("ì„¤ì • ì €ì¥ ì™„ë£Œ");
      renderBalance();
    });

    // ê¸°ì´ˆ ì”ê³  ì €ì¥(ì¤‘ìš”): ì €ì¥ ì „ í™•ì¸ íŒì—…
    $("btnSaveOpeningBalance").addEventListener("click", async () => {
      if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");

      const btn = $("btnSaveOpeningBalance");
      const v = Number($("openingBalance").value || 0);
      if(v < 0) return alert("ê¸°ì´ˆ ì”ê³ ëŠ” 0 ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.");

      // í˜„ì¬/ë³€ê²½ í›„ ì”ê³ ë¥¼ ë¯¸ë¦¬ ë³´ì—¬ì£¼ë©´ ì‹¤ìˆ˜ ë°©ì§€ê°€ ë©ë‹ˆë‹¤.
      const year = new Date().getFullYear();
      const curOpening = Number(cachedConfig?.openingBalance || 0);
      const ys = await ensureYearStatsBuilt(year);
      const inSum = Number(ys?.inSum || 0);
      const outSum = Number(ys?.outSum || 0);
      const curBalance = curOpening + inSum - outSum;
      const newBalance = v + inSum - outSum;

      const ok = confirm(`âš ï¸ ê¸°ì´ˆ ì”ê³  ë³€ê²½ í™•ì¸

`+
        `ì´ ì‘ì—…ì€ ê±°ë˜ë‚´ì—­ì„ ì§€ìš°ì§€ ì•ŠìŠµë‹ˆë‹¤.
`+
        `ëŒ€ì‹œë³´ë“œ ì”ê³ ê°€ (ê¸°ì´ˆ ì”ê³  + ì˜¬í•´ ì…ê¸ˆ - ì˜¬í•´ ì§€ì¶œ)ë¡œ ë‹¤ì‹œ ê³„ì‚°ë©ë‹ˆë‹¤.

`+
        `- í˜„ì¬ ê¸°ì´ˆ ì”ê³ : ${fmtWon(curOpening)}
`+
        `- ë³€ê²½ í›„ ê¸°ì´ˆ ì”ê³ : ${fmtWon(v)}

`+
        `- í˜„ì¬ ì”ê³ : ${fmtWon(curBalance)}
`+
        `- ë³€ê²½ í›„ ì”ê³ : ${fmtWon(newBalance)}

`+
        `ê·¸ë˜ë„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
      if(!ok) return;

      try{
        if(btn) btn.disabled = true;

        const yearStr = String(year);
        const ref = doc(db, "config", configDocId());
        await setDoc(ref, { openingYear: yearStr, openingBalance: v }, { merge:true });
        cachedConfig.openingYear = yearStr;
        cachedConfig.openingBalance = v;

        toast("ê¸°ì´ˆ ì”ê³  ì €ì¥ ì™„ë£Œ");
        state.yearStatsCurrent = await ensureYearStatsBuilt(year);
        renderBalance();
      } catch(e){
        alert(e?.message || String(e));
        console.error(e);
      } finally {
        if(btn) btn.disabled = !state.admin;
      }
    });

    // ê¸ˆì•¡ ë°ì´í„° ì´ˆê¸°í™”(ê°œë°œìš©)
    $("btnResetMoney").addEventListener("click", resetMoneyData);

    $("btnRebuildYearStats")?.addEventListener("click", async () => {
      if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");

      const nowY = new Date().getFullYear();
      const startY = Number(prompt("ì¬ê³„ì‚° ì‹œì‘ ì—°ë„(ì˜ˆ: 2024)", String(nowY - 1)) || 0);
      if(!startY) return;

      const endY = Number(prompt("ì¬ê³„ì‚° ì¢…ë£Œ ì—°ë„", String(nowY)) || 0);
      if(!endY || endY < startY) return;

      toast("ì—°ë„ í•©ê³„ ì¬ê³„ì‚° ì¤‘...");
      for(let y = startY; y <= endY; y++){
        const txs = await loadTransactionsForYear(y);
        const { inSum, outSum } = calcSums(txs);
        await setDoc(yearStatsRef(y), { inSum, outSum, rebuiltAt: Timestamp.now() }, { merge:true });
        yearStatsCache.set(String(y), { inSum, outSum });
        if(y === nowY) state.yearStatsCurrent = { inSum, outSum };
      }

      renderBalance();
      toast("ì—°ë„ í•©ê³„ ì¬ê³„ì‚° ì™„ë£Œ");
    });

    // ì›” ìƒì„±
    $("btnGenForAll").addEventListener("click", async () => {
      if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      const startYm = $("genStart").value.trim();
      const endYm = $("genEnd").value.trim();
      if(!isYm(startYm) || !isYm(endYm)) return alert("ë²”ìœ„ëŠ” YYYY-MM");

      toast("ì „ì²´ íšŒì› ì›” ìƒì„± ì‹œì‘...");
      for(const m of state.members){
        await ensureMemberPeriodsForRange({ member: m, startYm, endYm, recalc:false });
      }
      toast("ì „ì²´ íšŒì› ì›” ìƒì„± ì™„ë£Œ");
    });

    $("btnGenForOne").addEventListener("click", async () => {
      if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      const startYm = $("genStart").value.trim();
      const endYm = $("genEnd").value.trim();
      const memberId = $("genMember").value;
      if(!isYm(startYm) || !isYm(endYm)) return alert("ë²”ìœ„ëŠ” YYYY-MM");
      const member = state.members.find(x => x.name === memberId);
      if(!member) return alert("íšŒì› ì„ íƒ í•„ìš”");

      toast("ì„ íƒ íšŒì› ì›” ìƒì„±...");
      await ensureMemberPeriodsForRange({ member, startYm, endYm, recalc:false });
      toast("ì™„ë£Œ");
    });

    $("btnRecalcRange").addEventListener("click", async () => {
      if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
      const startYm = $("genStart").value.trim();
      const endYm = $("genEnd").value.trim();
      const memberId = $("genMember").value;
      if(!isYm(startYm) || !isYm(endYm)) return alert("ë²”ìœ„ëŠ” YYYY-MM");
      const member = state.members.find(x => x.name === memberId);
      if(!member) return alert("íšŒì› ì„ íƒ í•„ìš”");

      toast("ì¬ê³„ì‚° ì‹œì‘...");
      await ensureMemberPeriodsForRange({ member, startYm, endYm, recalc:true });
      toast("ì¬ê³„ì‚° ì™„ë£Œ");
    });

    // ê¸°íƒ€ ìˆ˜ì… ë“±ë¡
    $("btnAddOtherIncome")?.addEventListener("click", async () => {
      if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");

      const title = $("otherInTitle").value.trim();
      const amount = Number($("otherInAmount").value || 0);
      const dateStr = $("otherInDate").value;
      const memo = $("otherInMemo").value.trim();

      if(!title) return alert("ìˆ˜ì…ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
      if(!amount || amount <= 0) return alert("ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”.");
      if(!dateStr) return alert("ë‚ ì§œ ì„ íƒ í•„ìš”");

      try{
        const [y,m,d] = dateStr.split("-").map(Number);
        const date = Timestamp.fromDate(new Date(y, m-1, d, 12, 0, 0));

        const txRef = doc(collection(db, colName("transactions")));
        const txYear = yearOf(date);

        await runTransaction(db, async (t) => {
          t.set(txRef, {
            type: "IN",
            category: "OTHER_INCOME",
            incomeTitle: title,
            amount,
            memo,
            date,
            createdByUid: state.user.uid,
            createdAt: Timestamp.now()
          });

          bumpYearStatsInTxn(t, txYear, { inDelta: amount });
        });

        bumpYearStatsLocal(txYear, { inDelta: amount });

        $("otherInTitle").value = "";
        $("otherInAmount").value = "";
        $("otherInMemo").value = "";
        toast("ê¸°íƒ€ ìˆ˜ì… ë“±ë¡ ì™„ë£Œ");
        await refreshAll();
        setTab("dashboard");
      } catch(e){
        alert(e?.message || String(e));
        console.error(e);
      }
    });

    // ì…ê¸ˆ ë“±ë¡
    $("btnAddDeposit").addEventListener("click", async () => {
      if(!state.admin) return alert("ì´ë¬´ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");

      const memberId = $("inMember").value;
      const amount = Number($("inAmount").value || 0);
      const memo = $("inMemo").value.trim();
      const dateStr = $("inDate").value;
      const mode = $("inMode").value;

      if(!memberId) return alert("ì…ê¸ˆìë¥¼ ì„ íƒí•˜ì„¸ìš”.");
      if(!amount || amount <= 0) return alert("ê¸ˆì•¡ì„ í™•ì¸í•˜ì„¸ìš”.");
      if(!dateStr) return alert("ë‚ ì§œ ì„ íƒ í•„ìš”");

      try{
        // ê²½ì¡°ì‚¬(EVENT) ëª¨ë“œëŠ” payEventContribution ì•ˆì—ì„œ ê±°ë˜ë‚´ì—­/ë°°ì •ê¹Œì§€ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        if(mode === "EVENT"){
          const eventId = $("inEvent")?.value;
          if(!eventId) return alert("ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
          await payEventContribution({ eventId, memberId, amount, memo, dateStr });
                } else {
          const [y,m,d] = dateStr.split("-").map(Number);
          const date = Timestamp.fromDate(new Date(y, m-1, d, 12, 0, 0));
          const txYear = yearOf(date);

          if(mode === "MONTHLY"){
            const txRef = doc(collection(db, colName("transactions")));

            await runTransaction(db, async (t) => {
              t.set(txRef, {
                type: "IN",
                category: "MONTHLY_FEE",
                amount,
                memberId,
                memberName: memberId,
                memo,
                date,
                createdByUid: state.user.uid,
                createdAt: Timestamp.now()
              });
              bumpYearStatsInTxn(t, txYear, { inDelta: amount });
            });

            bumpYearStatsLocal(txYear, { inDelta: amount });

            // ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ
            await allocateMonthlyFIFO({ memberId, txId: txRef.id, amount });

          } else {
            // CREDIT ëª¨ë“œ: ì„ ìˆ˜ê¸ˆë§Œ ì ë¦½ + ê±°ë˜ ê¸°ë¡ + allocations + yearStatsë¥¼ í•œ íŠ¸ëœì­ì…˜ì—ì„œ ì²˜ë¦¬
            const txRef = doc(collection(db, colName("transactions")));
            const creditRef = doc(db, colName("credits"), memberId);
            const allocRef = doc(collection(db, colName("allocations")));

            await runTransaction(db, async (t) => {
              const snap = await t.get(creditRef);
              const cur = snap.exists() ? Number(snap.data().balance || 0) : 0;

              t.set(txRef, {
                type: "IN",
                category: "CREDIT",
                amount,
                memberId,
                memberName: memberId,
                memo,
                date,
                createdByUid: state.user.uid,
                createdAt: Timestamp.now()
              });

              t.set(creditRef, { balance: cur + amount }, { merge:true });

              t.set(allocRef, {
                txId: txRef.id,
                memberId,
                targetType: "CREDIT",
                targetId: memberId,
                amount,
                createdAt: Timestamp.now()
              });

              bumpYearStatsInTxn(t, txYear, { inDelta: amount });
            });

            bumpYearStatsLocal(txYear, { inDelta: amount });
          }
        }


        $("inAmount").value = "";
        $("inMemo").value = "";
        toast("ì…ê¸ˆ ë“±ë¡ ì™„ë£Œ");
        await refreshAll();
        setTab("dashboard");
      } catch(e){
        alert(e?.message || String(e));
        console.error(e);
      }
    });

    /*********************
     * 11) í™”ë©´ ë Œë”
     *********************/

    function fillMemberSelects(){
  const opts = state.members.map(m => `<option value="${escapeHtml(m.name)}">${escapeHtml(m.name)}</option>`).join("");
  const empty = `<option value="">(ì„ íƒ)</option>`;
  const emptyMemberStatus = `<option value="">(íšŒì›)</option>`;
  const emptySelf = `<option value="">(ê²½ì¡°ì‚¬ íšŒì› ë³¸ì¸)</option>`;

  $("memberSelect").innerHTML = emptyMemberStatus + opts;
  $("inMember").innerHTML = empty + opts;
  $("exMember").innerHTML = empty + opts;
  $("genMember").innerHTML = empty + opts;

  // ì§€ì¶œ(ê²½ì¡°ì‚¬) ë‹¹ì‚¬ì
  if($("outTargetMember")) $("outTargetMember").innerHTML = emptySelf + opts;

  // ê²½ì¡°ì‚¬ ì´ë²¤íŠ¸ ìƒì„±: ë³¸ì¸ ì„ íƒ
  if($("evTargetMember")) {
    $("evTargetMember").innerHTML = emptySelf + opts;
    // change ì´ë²¤íŠ¸ëŠ” ì¤‘ë³µ ë“±ë¡ ë°©ì§€ ìœ„í•´ onchange ì‚¬ìš©
    $("evTargetMember").onchange = () => syncEvExcludeTarget();
  }

  // ì œì™¸ íšŒì› ì²´í¬ë¦¬ìŠ¤íŠ¸
  renderEvExcludeList();
  syncEvExcludeTarget();
}

function renderEvExcludeList(){
  const host = $("evExcludeList");
  if(!host) return;
  if(!state.members || state.members.length === 0){
    host.innerHTML = `<div class="muted tiny">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  host.innerHTML = state.members.map((m, idx) => {
    const safe = escapeHtml(m.name);
    return `
      <label class="checkItem">
        <input type="checkbox" value="${safe}" />
        <span>${safe}</span>
      </label>
    `;
  }).join("");
}

function syncEvExcludeTarget(){
  const host = $("evExcludeList");
  if(!host) return;
  const target = $("evTargetMember")?.value || "";
  host.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    const isTarget = cb.value === target;
    if(isTarget){
      cb.checked = false;
      cb.disabled = true;
    } else {
      cb.disabled = false;
    }
  });
}

function getSelectedEventExcludes(){
  const host = $("evExcludeList");
  if(!host) return [];
  return [...host.querySelectorAll('input[type="checkbox"]:checked')].map(cb => cb.value);
}

function clearEventExcludeChecks(){
  const host = $("evExcludeList");
  if(!host) return;
  host.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = false; });
  syncEvExcludeTarget();
}

    function renderMemberList(){
      if(state.members.length === 0){
        $("memberList").innerHTML = `<div class="muted">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤. (ì´ë¬´ê°€ íšŒì›ì„ ì¶”ê°€í•˜ì„¸ìš”)</div>`;
        return;
      }

      $("memberList").innerHTML = state.members.map(m => {
        const ex = Array.isArray(m.exemptions) ? m.exemptions : [];
        const exHtml = ex.length
          ? ex.map((x, idx) => {
              const label = `${escapeHtml(x.from)}~${escapeHtml(x.to)}${x.reason?` (${escapeHtml(x.reason)})`:''}`;
              const adminBtns = state.admin
                ? `<button class="linkBtn tiny" data-action="editEx" data-member="${escapeHtml(m.name)}" data-idx="${idx}">ìˆ˜ì •</button>
                   <button class="linkBtn tiny danger" data-action="delEx" data-member="${escapeHtml(m.name)}" data-idx="${idx}">ì‚­ì œ</button>`
                : "";
              return `<div class="row" style="justify-content:space-between; gap:8px; padding:6px 0; border-bottom:1px dashed rgba(255,255,255,.08);">
                        <div class="muted tiny">${label}</div>
                        <div class="row" style="gap:6px;">${adminBtns}</div>
                      </div>`;
            }).join("")
          : `<div class="muted tiny">ì—†ìŒ</div>`;

        const adminActions = state.admin
          ? `<div class="row" style="gap:8px; justify-content:flex-end;">
               <button class="linkBtn tiny" data-action="editMember" data-member="${escapeHtml(m.name)}">íšŒì› ìˆ˜ì •</button>
               <button class="linkBtn tiny danger" data-action="kickMember" data-member="${escapeHtml(m.name)}">ì œëª…(í™œë™ì¢…ë£Œ)</button>
             </div>`
          : "";

        return `
          <div class="tx">
            <div class="txTop">
              <div><b>${escapeHtml(m.name)}</b></div>
              <div class="muted tiny">${escapeHtml(m.activeFrom || "")} ~ ${escapeHtml(m.activeTo || "í™œë™ì¤‘")}</div>
            </div>
            <div class="hr" style="margin:8px 0;"></div>
            <div class="muted tiny"><b>ë©´ì œ ëª©ë¡</b></div>
            <div style="margin-top:6px;">${exHtml}</div>
            ${adminActions}
          </div>
        `;
      }).join("");
    }

    async function refreshMembers(){
      state.members = await loadMembers();
      fillMemberSelects();
      renderMemberList();
    }

    async function refreshConfig(){
      cachedConfig = await getConfig();
      renderFeeHistory();
    }

    async function refreshAll(){
      await Promise.all([
        refreshMembers(),
        refreshConfig(),
        refreshEvents()
      ]);

      // âœ… ìƒˆí•´ê°€ ë˜ë©´ ìë™ìœ¼ë¡œ ê¸°ì´ˆ ì”ê³  ì´ì›”
      await ensureOpeningForCurrentYear();

const year = new Date().getFullYear();
const [recent, ys] = await Promise.all([
  loadTransactions(),
  ensureYearStatsBuilt(year)
]);
state.tx = recent;
state.yearStatsCurrent = ys;
await applyTxView({ force:false });
renderBalance();

      lastDashboardRefreshAt = Date.now();
      lastConfigRefreshAt = Date.now();

      // ê¸°ë³¸ ë²”ìœ„
      if(!$("rangeStart").value || !$("rangeEnd").value){
        $("btnQuickRange").click();
      }

      // ê¸°ë³¸ ë‚ ì§œ
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,"0");
      const dd = String(now.getDate()).padStart(2,"0");
      if(!$('inDate').value) $('inDate').value = `${yyyy}-${mm}-${dd}`;
      if($("otherInDate") && !$("otherInDate").value) $("otherInDate").value = `${yyyy}-${mm}-${dd}`;
      if($("outDate") && !$("outDate").value) $("outDate").value = `${yyyy}-${mm}-${dd}`;
      if($("evDate") && !$("evDate").value) $("evDate").value = `${yyyy}-${mm}-${dd}`;
      if($("evPerAmount") && !$("evPerAmount").value) $("evPerAmount").value = "100000";
      syncInEventUI();

      // ì›” ìƒì„± ê¸°ë³¸ê°’ (A ì¶”ì²œ: ë„‰ë„‰)
      if(!$("genStart").value) $("genStart").value = "2024-01";
      if(!$("genEnd").value) $("genEnd").value = "2026-12";
    }

    /*********************
     * 12) Auth state
     *********************/
    onAuthStateChanged(auth, async (user) => {
      state.user = user;
      if(!user){
        lockUI(false);
        state.admin = false;
        PRACTICE_MODE = false;
        localStorage.removeItem("practice_mode");
        applyRoleBadge();
        syncAdminLocks();
        syncPracticeUI();
        $("userLabel").textContent = "";
        $("uidLabel").textContent = "";
        return;
      }

      lockUI(true);
      $("userLabel").textContent = user.email || "ë¡œê·¸ì¸ë¨";
      $("uidLabel").textContent = `UID: ${user.uid}`;

      state.admin = await isAdmin(user.uid);

      // ì—°ìŠµ ëª¨ë“œ(ë¡œì»¬ ì €ì¥: ì´ë¬´ ê¸°ê¸° ì „ìš©)
      PRACTICE_MODE = !!(state.admin && localStorage.getItem("practice_mode") === "1");
      if(!state.admin){
        PRACTICE_MODE = false;
        localStorage.removeItem("practice_mode");
      }

      applyRoleBadge();
      syncAdminLocks();
      syncPracticeUI();

      await refreshAll();
      setTab("dashboard");
      // ê²½ì¡°ì‚¬(ì§€ì¶œ) ì„ íƒ ì‹œ ë‹¹ì‚¬ì ì„ íƒì¹¸ í† ê¸€ ì´ˆê¸°í™”
      syncOutTargetUI();

      toast(state.admin ? "ì´ë¬´ë¡œ ë¡œê·¸ì¸" : "íšŒì›ìœ¼ë¡œ ë¡œê·¸ì¸");
    });

    // ì²« ë¡œë“œ: ì ê¸ˆ í™”ë©´ ìœ ì§€
    lockUI(false);
  </script>
</body>
</html>
